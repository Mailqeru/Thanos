<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>TTMS - View Students</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--utm-blue: #003366;
--utm-gold: #C9A85C;
--light-bg: #f5f7fa;
--card-bg: #ffffff;
--border-color: #e5e7eb;
--text-primary: #1f2937;
--text-secondary: #6b7280;
--success: #10b981;
--warning: #f59e0b;
--error: #ef4444;
--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
* {
box-sizing: border-box;
}
body {
margin: 0;
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
background-color: var(--light-bg);
color: var(--text-primary);
line-height: 1.6;
}
/* Sidebar */
.w3-sidebar {
background: linear-gradient(180deg, var(--utm-blue) 0%, #002244 100%) !important;
box-shadow: 2px 0 12px rgba(0,0,0,0.15);
z-index: 1000;
}
.sidebar-header {
padding: 24px 20px;
border-bottom: 1px solid rgba(255,255,255,0.1);
text-align: center;
}
.sidebar-logo {
font-size: 28px;
color: var(--utm-gold);
margin-bottom: 8px;
}
.sidebar-title {
color: white;
font-size: 16px;
font-weight: 600;
margin: 0;
letter-spacing: 0.5px;
}
.sidebar-subtitle {
color: rgba(255,255,255,0.7);
font-size: 12px;
margin: 4px 0 0;
}
.w3-sidebar .w3-bar-item {
color: rgba(255,255,255,0.9) !important;
border-bottom: none;
padding: 16px 20px;
transition: all 0.3s ease;
font-weight: 500;
position: relative;
}
.w3-sidebar .w3-bar-item:hover {
background-color: rgba(201, 168, 92, 0.15) !important;
color: white !important;
padding-left: 28px;
}
.w3-sidebar .w3-bar-item.active {
background-color: var(--utm-gold) !important;
color: var(--utm-blue) !important;
font-weight: 600;
}
.w3-sidebar .w3-bar-item i {
margin-right: 12px;
width: 20px;
text-align: center;
}
/* Header */
.w3-teal {
background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%) !important;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.header-content {
display: flex;
justify-content: space-between;
align-items: center;
padding: 20px 0;
}
.header-title {
margin: 0;
color: white;
font-size: 28px;
font-weight: 700;
}
/* Main Content */
.w3-main {
background-color: var(--light-bg);
min-height: 100vh;
transition: margin-left 0.3s;
}
.content-wrapper {
padding: 32px;
max-width: 1400px;
}
/* Cards */
.card {
background: var(--card-bg);
border-radius: 12px;
padding: 24px;
margin-bottom: 24px;
box-shadow: var(--shadow-md);
border: 1px solid var(--border-color);
}
.card-header {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 16px;
padding-bottom: 16px;
border-bottom: 2px solid var(--border-color);
}
.card-header i {
font-size: 24px;
color: var(--utm-blue);
}
.card-header h3 {
margin: 0;
font-size: 20px;
font-weight: 600;
color: var(--text-primary);
}
/* Form Controls */
.form-row {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 16px;
align-items: end;
}
.form-group {
display: flex;
flex-direction: column;
}
.form-group label {
display: flex;
align-items: center;
gap: 8px;
font-weight: 600;
font-size: 14px;
margin-bottom: 8px;
color: var(--text-primary);
}
.form-group label i {
color: var(--utm-blue);
}
.w3-input, .w3-select {
width: 100%;
border: 1px solid var(--border-color);
border-radius: 8px;
padding: 12px;
font-size: 14px;
background: white;
transition: border-color 0.2s;
}
.w3-input:focus, .w3-select:focus {
outline: none;
border-color: var(--utm-blue);
}
.btn {
padding: 12px 24px;
border-radius: 8px;
border: none;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
display: inline-flex;
align-items: center;
gap: 8px;
white-space: nowrap;
}
.btn-primary { background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-info { background: #0ea5e9; color: white; }
.btn-purple { background: #7c3aed; color: white; }
.btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}
.btn-group {
display: flex;
flex-wrap: wrap;
gap: 12px;
margin-top: 16px;
}
/* Stats & Debug */
.stats-card {
background: #e8f5e9;
border-left: 4px solid var(--success);
padding: 16px;
border-radius: 8px;
margin: 16px 0;
font-size: 14px;
}
.debug-card {
background: #f0f8ff;
border-left: 4px solid var(--utm-blue);
padding: 16px;
border-radius: 8px;
margin: 16px 0;
font-size: 14px;
color: #2c3e50;
display: none !important; /*hide the div*/
}
/* Table */
.table-wrapper {
overflow-x: auto;
margin: 20px 0;
border-radius: 8px;
border: 1px solid var(--border-color);
}
table.w3-table {
width: 100%;
border-collapse: collapse;
background: white;
margin: 0;
font-size: 14px;
}
table.w3-table thead tr {
background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%);
color: white;
}
table.w3-table th {
padding: 14px 12px;
text-align: left;
font-weight: 600;
font-size: 13px;
text-transform: uppercase;
letter-spacing: 0.5px;
}
table.w3-table td {
padding: 12px;
border-bottom: 1px solid var(--border-color);
}
table.w3-table tbody tr:hover {
background-color: #f8f9fa;
}
.status-tag {
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.status-active { background-color: #e8f5e9; color: #2e7d32; }
.status-inactive { background-color: #f5f5f5; color: #666; }
.action-btn {
padding: 6px 12px !important;
font-size: 12px !important;
}
.back-btn {
margin-bottom: 20px;
display: inline-flex;
align-items: center;
gap: 8px;
background: var(--utm-blue) !important;
color: white !important;
padding: 8px 16px !important;
border-radius: 8px !important;
}
.back-btn:hover {
background: #002244 !important;
}
/* Pagination */
.pagination-info {
font-size: 13px;
color: var(--text-secondary);
display: flex;
align-items: center;
gap: 8px;
margin: 16px 0;
}
.pagination-controls .w3-bar {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 6px;
}
.pagination-controls .w3-button {
min-width: 36px;
height: 36px;
display: flex;
align-items: center;
justify-content: center;
padding: 0;
font-size: 13px;
border-radius: 6px;
}
/* Empty State */
.empty-state {
text-align: center;
padding: 48px 24px;
color: var(--text-secondary);
background: #fafafa;
border-radius: 12px;
margin: 24px 0;
}
.empty-state i {
font-size: 48px;
color: var(--utm-blue);
margin-bottom: 16px;
}
/* Loading & Error */
.loading-container {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 48px;
gap: 16px;
}
.spinner {
width: 48px;
height: 48px;
border: 4px solid var(--border-color);
border-top-color: var(--utm-blue);
border-radius: 50%;
animation: spin 1s linear infinite;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
.loading-text {
font-size: 16px;
color: var(--text-secondary);
font-weight: 500;
}
.error-container {
background: #fef2f2;
border: 1px solid #fecaca;
border-left: 4px solid var(--error);
border-radius: 12px;
padding: 20px;
margin-bottom: 24px;
}
.error-container h4 {
display: flex;
align-items: center;
gap: 8px;
margin: 0 0 8px 0;
color: #991b1b;
font-size: 16px;
}
.error-container p {
margin: 0;
color: #991b1b;
font-size: 14px;
}
#errorDetails {
margin-top: 16px;
}
#errorDetailsContent {
background: #f8f8f8;
padding: 12px;
border-radius: 6px;
overflow: auto;
max-height: 300px;
font-size: 13px;
font-family: monospace;
}
/* Responsive */
@media (max-width: 768px) {
.content-wrapper {
padding: 20px;
}
.form-row {
grid-template-columns: 1fr;
}
.btn-group {
flex-direction: column;
}
.btn {
width: 100%;
justify-content: center;
}
.pagination-info {
flex-direction: column;
align-items: flex-start;
gap: 8px;
}
.card-header {
flex-direction: column;
align-items: flex-start;
}
}
</style>
</head>
<body>
<!-- Sidebar -->
<div class="w3-sidebar w3-bar-block w3-collapse w3-card" style="width:260px;" id="mySidebar">
<div class="sidebar-header">
<div class="sidebar-logo">
<i class="fas fa-graduation-cap"></i>
</div>
<h2 class="sidebar-title">TTMS</h2>
<p class="sidebar-subtitle">Timetable Management System</p>
</div>
<a href="Admin.html" class="w3-bar-item w3-button">
<i class="fas fa-home"></i> Dashboard
</a>
<a href="ViewLecturers.html" class="w3-bar-item w3-button">
<i class="fas fa-chalkboard-teacher"></i> Lecturers
</a>
<a href="ViewStudents.html" class="w3-bar-item w3-button active">
<i class="fas fa-user-graduate"></i> Students
</a>
<a href="ViewSubjects.html" class="w3-bar-item w3-button">
<i class="fas fa-book-open"></i> Subjects
</a>
<a href="RoomUtilization.html" class="w3-bar-item w3-button">
<i class="fas fa-door-open"></i> Room Utilization
</a>
<a href="Reports.html" class="w3-bar-item w3-button">
<i class="fas fa-chart-bar"></i> Reports
</a>
<a href="#" class="w3-bar-item w3-button" id="navLogout" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
<i class="fas fa-sign-out-alt"></i> Logout
</a>
</div>
<!-- Main Content -->
<div class="w3-main" style="margin-left:260px">
<div class="w3-teal">
<button class="w3-button w3-teal w3-xlarge w3-hide-large" onclick="w3_open()" style="padding: 16px;">&#9776;</button>
<div class="w3-container">
<div class="header-content">
<h1 class="header-title">View Students</h1>
</div>
</div>
</div>
<div class="content-wrapper">
<!-- Description Card -->
<div class="card">
<div class="card-header">
<i class="fas fa-graduation-cap"></i>
<h3>View Students</h3>
</div>
<p>Browse and search students by session, semester, and apply pagination limits.</p>
</div>
<!-- Debug Info -->
<div class="card debug-card">
<strong><i class="fas fa-bug"></i> Session Information</strong><br>
• Stored Session ID (Password): <code id="debugPassword">Loading...</code><br>
• Extracted Real Session ID: <span id="debugRealSession">Not extracted yet</span><br>
• Auth URL: <span id="debugAuthUrl">Not generated</span>
</div>
<!-- Filters -->
<div class="card">
<div class="form-row">
<div class="form-group">
<label for="sessionSelect">
<i class="fas fa-calendar-alt"></i> Academic Session
</label>
<select class="w3-select" id="sessionSelect"></select>
</div>
<div class="form-group">
<label for="semesterSelect">
<i class="fas fa-book"></i> Semester
</label>
<select class="w3-select" id="semesterSelect">
<option value="1">Semester 1</option>
<option value="2">Semester 2</option>
<option value="3">Special Semester</option>
</select>
</div>
<div class="form-group">
<label for="limitSelect">
<i class="fas fa-list-ol"></i> Records Per Page
</label>
<select class="w3-select" id="limitSelect">
<option value="10">10 records</option>
<option value="20" selected>20 records</option>
<option value="50">50 records</option>
<option value="100">100 records</option>
<option value="200">200 records</option>
<option value="0">All records</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="searchInput">
<i class="fas fa-search"></i> Search Student
</label>
<input type="text" class="w3-input" id="searchInput" placeholder="Search by name or ID...">
</div>
<div class="form-group">
<label for="searchBySelect">
<i class="fas fa-filter"></i> Search By
</label>
<select class="w3-select" id="searchBySelect">
<option value="name">Student Name</option>
<option value="id">Student ID</option>
<option value="program">Program</option>
<option value="all">All Fields</option>
</select>
</div>
</div>
<div class="btn-group">
<button class="btn btn-primary" id="loadStudentsBtn">
<i class="fas fa-sync-alt"></i> Load Students
</button>
<button class="btn btn-success" id="applySearchBtn">
<i class="fas fa-search"></i> Search
</button>
<button class="btn btn-secondary" id="clearSearchBtn">
<i class="fas fa-times"></i> Clear
</button>
</div>
<!-- Pagination Info -->
<div class="w3-row" style="margin-top: 20px;">
<div class="w3-col s12 m6">
<div id="paginationInfo" class="pagination-info">
Page info will appear here
</div>
</div>
<div class="w3-col s12 m6">
<div id="paginationControls" class="pagination-controls w3-right"></div>
</div>
</div>
</div>
<!-- Session Info -->
<div id="sessionInfo" class="card debug-card" style="display:none;">
<strong><i class="fas fa-key"></i> Session Details</strong><br>
• Real Session ID: <code id="sessionUsedDisplay">Not loaded yet</code><br>
• API Status: <span id="apiStatus">Inactive</span>
</div>
<!-- Loading -->
<div id="loadingSpinner" class="card" style="display:none;">
<div class="loading-container">
<div class="spinner"></div>
<div class="loading-text">Loading all student data... This may take a moment.</div>
</div>
</div>
<!-- Error -->
<div id="errorContainer" class="error-container" style="display:none;">
<h4>
<i class="fas fa-exclamation-triangle"></i>
<span id="errorTitle">Error</span>
</h4>
<p id="errorMessage"></p>
</div>
<!-- Stats -->
<div id="studentStats" class="stats-card" style="display:none;"></div>
<!-- Table -->
<div id="studentTableContainer" class="card">
<div class="empty-state">
<i class="fas fa-users"></i>
<h4>Ready to Load Students</h4>
<p>Configure your filters above and click <strong>Load Students</strong> to begin.</p>
</div>
</div>
</div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
// Sidebar toggle
function w3_open() {
  document.getElementById("mySidebar").style.display = "block";
}
function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
}

// Auth validation
const rawSession = localStorage.getItem("TTMSFC_userSession");
if (!rawSession) {
  alert("Please log in first.");
  window.location.replace("../index.html");
}
let user;
try {
  user = JSON.parse(rawSession);
} catch (e) {
  localStorage.removeItem("TTMSFC_userSession");
  window.location.replace("../index.html");
}
if (user.inferredRole !== "admin") {
  alert("Admin access required.");
  window.location.replace("../index.html");
}

// Global state
let currentSessionId = null;
let fullStudentList = []; // ✅ All students in memory
let currentSesi = '';
let currentSemester = '';
let currentPage = 1;
let currentLimit = 20;

// Logout
document.getElementById("navLogout").onclick = function() {
  if (confirm("Logout now?")) {
    localStorage.removeItem("TTMSFC_userSession");
    localStorage.removeItem("TTMSFC_adminAuth");
    window.location.replace("../index.html");
  }
};

// Initialize UI
$(document).ready(function() {
  initStudentsPage();
  document.getElementById("loadStudentsBtn").click(); // auto-click
});

function initStudentsPage() {
  // Session debug
  if (rawSession) {
    try {
      const session = JSON.parse(rawSession);
      document.getElementById('debugPassword').textContent = session.session_id || 'No session ID';
    } catch (e) {
      document.getElementById('debugPassword').textContent = 'Invalid JSON';
    }
  }

  // Academic years
  const month = new Date().getMonth() + 1;
  const currentYear = new Date().getFullYear();
  const latestStartYear = (month >= 2 && month <= 7) ? currentYear : (currentYear - 1);
  const academicYears = [];
  for (let i = latestStartYear; i >= latestStartYear - 5; i--) {
    academicYears.push(`${i}/${i + 1}`);
  }
  const defaultSession = (month >= 2 && month <= 7) ? `${currentYear}/${currentYear + 1}` : `${currentYear - 1}/${currentYear}`;
  const sessionSelect = document.getElementById('sessionSelect');
  sessionSelect.innerHTML = academicYears.map(year =>
    `<option value="${year}" ${year === defaultSession ? 'selected' : ''}>${year}</option>`
  ).join('');
  document.getElementById("semesterSelect").value = (month >= 2 && month <= 7) ? "2" : "1";

  // Event listeners
  document.getElementById('loadStudentsBtn').onclick = fetchStudentData;
  document.getElementById('applySearchBtn').onclick = applySearch;
  document.getElementById('clearSearchBtn').onclick = clearSearch;
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') applySearch();
  });
}

// Extract session ID from auth HTML
function extractSessionIdFromResponse(text) {
  const patterns = [
    /name\s*=\s*["']session_id["']\s+value\s*=\s*["']([^"']+)/i,
    /value\s*=\s*["']([^"']+)["']\s+name\s*=\s*["']session_id["']/i,
    /session_id["']?\s*:\s*["']([^"']+)/i
  ];
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match && match[1]) return match[1].trim();
  }
  const ids = text.match(/[A-Za-z0-9]{20,}/g);
  return ids?.[0] || null;
}

// Fetch ALL students via pagination (up to 10k)
async function fetchAllStudentsPaginated(sessionId, sesi, semester) {
  let all = [];
  let offset = 0;
  const limit = 1000;
  const maxTotal = 10000;

  while (all.length < maxTotal) {
    const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${encodeURIComponent(sessionId)}&sesi=${encodeURIComponent(sesi)}&semester=${encodeURIComponent(semester)}&limit=${limit}&offset=${offset}`;
    const res = await fetch(url);
    const text = await res.text();

    if (!text.trim() || text.trim().startsWith("The most simple ever")) {
      if (offset === 0) return [];
      break;
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      if (offset === 0) return [];
      break;
    }

    const page = Array.isArray(data) ? data : (data ? [data] : []);
    if (page.length === 0) break;

    all.push(...page);
    if (page.length < limit) break;

    offset += limit;
  }
  return all;
}

// Main fetch function
async function fetchStudentData() {
  const raw = localStorage.getItem("TTMSFC_userSession");
  if (!raw) return showError("Session missing", "Please log in again.");

  let session;
  try {
    session = JSON.parse(raw);
  } catch (e) {
    return showError("Invalid session", "Session corrupted.");
  }

  if (!session.session_id) return showError("Session ID missing", "Invalid session.");

  const sessionId = session.session_id;
  currentSesi = document.getElementById('sessionSelect').value;
  currentSemester = document.getElementById('semesterSelect').value;
  currentLimit = parseInt(document.getElementById('limitSelect').value) || 20;
  currentPage = 1;

  showLoading(true);
  hideError();

  try {
    // Authenticate to get real session ID
    const authUrl = `http://web.fc.utm.my/ttms/auth-admin.php?session_id=${encodeURIComponent(sessionId)}`;
    document.getElementById('debugAuthUrl').textContent = authUrl;
    const authRes = await fetch(authUrl);
    const authText = await authRes.text();
    const realSessionId = extractSessionIdFromResponse(authText);
    if (!realSessionId) throw new Error("Could not extract real session ID.");
    currentSessionId = realSessionId;

    // Update UI
    document.getElementById('debugRealSession').textContent = realSessionId;
    document.getElementById('debugRealSession').style.color = 'green';
    document.getElementById('sessionUsedDisplay').textContent = realSessionId;
    document.getElementById('apiStatus').textContent = 'Active';
    document.getElementById('sessionInfo').style.display = 'block';

    // ✅ Load ALL students once
    document.querySelector('.loading-text').textContent = 'Loading all students... (up to 10,000)';
    fullStudentList = await fetchAllStudentsPaginated(realSessionId, currentSesi, currentSemester);

    // Show first page
    renderCurrentPage();
    updateStats(fullStudentList);
    updatePaginationInfo();
    renderPaginationControls();

  } catch (error) {
    console.error("Fetch error:", error);
    showError("Load Failed", error.message);
  } finally {
    showLoading(false);
    document.querySelector('.loading-text').textContent = 'Loading student data...';
  }
}

// Render current page from full list
function renderCurrentPage() {
  const start = (currentPage - 1) * currentLimit;
  const end = currentLimit === 0 ? fullStudentList.length : start + currentLimit;
  const pageData = fullStudentList.slice(start, end);
  renderStudentTable(pageData);
}

// Render table
function renderStudentTable(data) {
  const container = document.getElementById('studentTableContainer');
  if (!data || data.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-user-slash"></i>
        <h4>No Students Found</h4>
        <p>No student records found.</p>
      </div>`;
    return;
  }

  const first = data[0];
  const hasProgram = first.program || first.kod_program;
  const hasFaculty = first.fakulti || first.faculty;
  const hasStatus = 'status' in first;

  let html = `<div style="overflow-x:auto;"><table class="w3-table w3-bordered w3-striped"><thead><tr>
    <th>#</th>
    <th>Student ID</th>
    <th>Name</th>
    ${hasProgram ? '<th>Program</th>' : ''}
    ${hasFaculty ? '<th>Faculty</th>' : ''}
    ${hasStatus ? '<th>Status</th>' : ''}
    <th>Actions</th>
  </tr></thead><tbody>`;

  data.forEach((student, idx) => {
    const globalIndex = (currentPage - 1) * currentLimit + idx + 1;
    const id = student.no_matrik || student.id || 'N/A';
    const name = student.nama || student.name || 'Unknown';
    const program = student.program || student.kod_program || 'N/A';
    const faculty = student.fakulti || student.faculty || 'N/A';
    const status = student.status || 'Active';
    const statusCls = status.toLowerCase() === 'active' ? 'status-active' : 'status-inactive';

    html += `<tr>
      <td>${globalIndex}</td>
      <td><strong>${id}</strong></td>
      <td>${name}</td>
      ${hasProgram ? `<td>${program}</td>` : ''}
      ${hasFaculty ? `<td>${faculty}</td>` : ''}
      ${hasStatus ? `<td><span class="status-tag ${statusCls}">${status}</span></td>` : ''}
      <td><button class="w3-button btn-info action-btn" onclick="viewStudentDetails('${id}')"><i class="fas fa-eye"></i> View</button></td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
}

// Search (on full list)
function applySearch() {
  const term = document.getElementById('searchInput').value.trim();
  const by = document.getElementById('searchBySelect').value;
  if (!term) return clearSearch();

  const t = term.toLowerCase();
  const filtered = fullStudentList.filter(student => {
    const id = (student.no_matrik || student.id || '').toString().toLowerCase();
    const name = (student.nama || student.name || '').toLowerCase();
    const prog = (student.program || student.kod_program || '').toLowerCase();
    const fac = (student.fakulti || student.faculty || '').toLowerCase();

    if (by === 'name') return name.includes(t);
    if (by === 'id') return id.includes(t);
    if (by === 'program') return prog.includes(t) || fac.includes(t);
    return name.includes(t) || id.includes(t) || prog.includes(t) || fac.includes(t);
  });

  // Show all results (ignore pagination limit during search)
  renderStudentTable(filtered);
  document.getElementById('paginationInfo').innerHTML = `<i class="fas fa-search"></i> Search results: <strong>${filtered.length}</strong> matching "${term}"`;
  document.getElementById('paginationControls').innerHTML = '';
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  currentPage = 1;
  renderCurrentPage();
  updatePaginationInfo();
  renderPaginationControls();
}

// Pagination
function updatePaginationInfo() {
  if (currentLimit === 0) {
    document.getElementById('paginationInfo').innerHTML = `<i class="fas fa-info-circle"></i> Showing all <strong>${fullStudentList.length}</strong> students`;
    return;
  }
  const start = (currentPage - 1) * currentLimit + 1;
  const end = Math.min(start + currentLimit - 1, fullStudentList.length);
  document.getElementById('paginationInfo').innerHTML = `<i class="fas fa-info-circle"></i> Showing <strong>${start}–${end}</strong> of <strong>${fullStudentList.length}</strong> | Page <strong>${currentPage}</strong>`;
}

function renderPaginationControls() {
  if (currentLimit === 0 || fullStudentList.length <= currentLimit) {
    document.getElementById('paginationControls').innerHTML = '';
    return;
  }

  const totalPages = Math.ceil(fullStudentList.length / currentLimit);
  let html = `<div class="w3-bar">
    <button class="w3-button" onclick="goToPage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>
      <i class="fas fa-chevron-left"></i>
    </button>
    <span class="w3-bar-item">Page ${currentPage} of ${totalPages}</span>
    <button class="w3-button" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>`;
  document.getElementById('paginationControls').innerHTML = html;
}

window.goToPage = function(page) {
  const totalPages = Math.ceil(fullStudentList.length / currentLimit);
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  renderCurrentPage();
  updatePaginationInfo();
  renderPaginationControls();
};

// Stats
function updateStats(data) {
  const stats = document.getElementById('studentStats');
  if (!data || data.length === 0) {
    stats.style.display = 'none';
    return;
  }
  let active = data.filter(s => (s.status || 'Active').toLowerCase() === 'active').length;
  stats.innerHTML = `<strong><i class="fas fa-chart-bar"></i> Statistics:</strong><br>• Total: <strong>${data.length}</strong><br>• Active: <strong>${active}</strong>`;
  stats.style.display = 'block';
}

// Student details
window.viewStudentDetails = async function(studentId) {
  if (!currentSessionId) {
    alert("Please load students first.");
    return;
  }
  const container = document.getElementById('studentTableContainer');
  container.innerHTML = `<button class="back-btn" onclick="backToStudentsList()"><i class="fas fa-arrow-left"></i> Back</button><div class="loading-container"><div class="spinner"></div><div>Loading subjects for ${studentId}...</div></div>`;

  try {
    const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&session_id=${encodeURIComponent(currentSessionId)}&no_matrik=${encodeURIComponent(studentId)}`;
    const res = await fetch(url);
    const text = await res.text();
    if (!text.trim()) throw new Error("No data");

    let subjects = JSON.parse(text);
    subjects = Array.isArray(subjects) ? subjects : (subjects ? [subjects] : []);
    const filtered = subjects.filter(s => s.sesi === currentSesi && String(s.semester) === String(currentSemester));

    if (filtered.length === 0) {
      container.innerHTML = `<button class="back-btn" onclick="backToStudentsList()">Back</button><div class="empty-state"><i class="fas fa-book"></i><h4>No Subjects</h4><p>No subjects for ${studentId}</p></div>`;
      return;
    }

    let html = `<button class="back-btn" onclick="backToStudentsList()">Back</button><div class="card"><h4>Subjects for ${studentId}</h4><p>${currentSesi} • Sem ${currentSemester}</p></div><table class="w3-table w3-bordered w3-striped"><thead><tr><th>#</th><th>Code</th><th>Name</th><th>Sec</th></tr></thead><tbody>`;
    filtered.forEach((s, i) => {
      html += `<tr><td>${i+1}</td><td>${s.kod_subjek || '—'}</td><td>${s.nama_subjek || '—'}</td><td>${s.seksyen || '—'}</td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<button class="back-btn" onclick="backToStudentsList()">Back</button><div class="error-container"><h4>Error</h4><p>${e.message}</p></div>`;
  }
};

window.backToStudentsList = function() {
  clearSearch(); // resets to page 1
};

// UI helpers
function showLoading(show) {
  document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
  document.getElementById('loadStudentsBtn').disabled = show;
}
function showError(title, msg) {
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorMessage').textContent = msg;
  document.getElementById('errorContainer').style.display = 'block';
}
function hideError() {
  document.getElementById('errorContainer').style.display = 'none';
}
</script>
</body>
</html>
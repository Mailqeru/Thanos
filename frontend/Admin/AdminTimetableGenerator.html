<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>TTMS - Timetable Generator</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --utm-blue: #003366;
      --utm-gold: #C9A85C;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-primary);
    }

    .w3-sidebar {
      background: linear-gradient(180deg, var(--utm-blue) 0%, #002244 100%) !important;
      box-shadow: 2px 0 12px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .sidebar-logo { font-size: 28px; color: var(--utm-gold); margin-bottom: 8px; }
    .sidebar-title { color: white; font-size: 16px; font-weight: 600; margin: 0; }
    .sidebar-subtitle { color: rgba(255,255,255,0.7); font-size: 12px; margin: 4px 0 0; }

    .w3-sidebar .w3-bar-item {
      color: rgba(255,255,255,0.9) !important;
      padding: 16px 20px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .w3-sidebar .w3-bar-item:hover {
      background-color: rgba(201, 168, 92, 0.15) !important;
      color: white !important;
    }

    .w3-sidebar .w3-bar-item.active {
      background-color: var(--utm-gold) !important;
      color: var(--utm-blue) !important;
      font-weight: 600;
    }

    .w3-sidebar .w3-bar-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    .w3-teal {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
    }

    .header-title {
      margin: 0;
      color: white;
      font-size: 28px;
      font-weight: 700;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--utm-gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--utm-blue);
    }

    .w3-main {
      background-color: var(--light-bg);
      min-height: 100vh;
      transition: margin-left 0.3s;
    }

    .content-wrapper {
      padding: 32px;
      max-width: 1400px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .w3-input, .w3-select {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      background: white;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .now-highlight {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 14px;
      border-radius: 0 8px 8px 0;
      font-weight: 600;
      color: #5d4037;
      margin-top: 20px;
      display: none;
    }

    .now-highlight.show {
      display: block;
    }

    /* UNIFIED TIMETABLE STYLE */
    .timetable-container .timetable-grid {
      display: grid;
      grid-template-columns: 140px repeat(5, 1fr);
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid var(--border-color);
    }
    
    .timetable-container .corner-cell {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #002244 100%);
      color: white; 
      font-weight: 700; 
      font-size: 13px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
    }
    
    .timetable-container .day-header {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #002244 100%);
      color: white; 
      font-weight: 700; 
      font-size: 13px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
    }
    
    .timetable-container .time-cell {
      background: #f8f9fa;
      color: var(--utm-blue); 
      font-weight: 700;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
      min-height: 90px;
    }
    
    .timetable-container .grid-cell {
      padding: 0;
      background: #fafbff;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: stretch;
      min-height: 90px;
    }
    
    .timetable-container .class-item {
      background: linear-gradient(135deg, #eef5ff 0%, #e0efff 100%);
      border-left: 5px solid var(--utm-blue);
      padding: 12px;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .timetable-container .class-code {
      font-weight: 700;
      color: var(--utm-blue);
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    .timetable-container .class-name {
      font-size: 11px;
      color: #555;
      margin-bottom: 4px;
      line-height: 1.3;
    }
    
    .timetable-container .class-room {
      font-size: 11px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    .timetable-container .class-room i {
      font-size: 10px;
    }

    .summary-bar {
      background: #eef5ff;
      border-left: 6px solid var(--utm-blue);
      padding: 15px 20px;
      border-radius: 8px;
      margin-top: 20px;
      color: var(--utm-blue);
      font-size: 14px;
    }

    .analysis-section {
      margin-top: 24px;
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--utm-blue);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .stat-card h4 {
      margin: 0 0 12px 0;
      color: var(--utm-blue);
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--utm-blue);
      margin: 8px 0;
    }

    .stat-label {
      font-size: 13px;
      color: #666;
    }

    .day-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .day-label {
      width: 80px;
      font-size: 12px;
      font-weight: 600;
      color: #555;
    }

    .bar-container {
      flex: 1;
      height: 24px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--utm-blue), #004080);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: white;
      font-size: 11px;
      font-weight: 600;
      transition: width 0.6s ease;
    }

    .time-slots {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .time-slot-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 12px;
    }

    .time-slot-time {
      font-weight: 600;
      color: var(--utm-blue);
    }

    .time-slot-count {
      background: var(--utm-blue);
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .rooms-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
    }

    .room-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 10px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 12px;
    }

    .room-name {
      font-weight: 600;
      color: #333;
    }

    .room-count {
      color: var(--utm-blue);
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .content-wrapper { padding: 20px; }
      .timetable-grid { display: none; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="w3-sidebar w3-bar-block w3-collapse w3-card" style="width:260px;" id="mySidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo"><i class="fas fa-graduation-cap"></i></div>
      <h2 class="sidebar-title">TTMS</h2>
      <p class="sidebar-subtitle">Timetable Management System</p>
    </div>
    
    <a href="Admin.html" class="w3-bar-item w3-button">
      <i class="fas fa-home"></i> Dashboard
    </a>
    <a href="ViewLecturers.html" class="w3-bar-item w3-button">
      <i class="fas fa-chalkboard-teacher"></i> Lecturers
    </a>
    <a href="ViewStudents.html" class="w3-bar-item w3-button">
      <i class="fas fa-user-graduate"></i> Students
    </a>
    <a href="AdminTimetableGenerator.html" class="w3-bar-item w3-button active">
      <i class="fas fa-calendar-alt"></i> Timetable Generator
    </a>
    <a href="ViewSubjects.html" class="w3-bar-item w3-button">
      <i class="fas fa-book-open"></i> Subjects
    </a>
    <a href="RoomUtilization.html" class="w3-bar-item w3-button">
      <i class="fas fa-door-open"></i> Room Utilization
    </a>
    <a href="Reports.html" class="w3-bar-item w3-button">
      <i class="fas fa-chart-bar"></i> Reports
    </a>
    <a href="#" class="w3-bar-item w3-button" id="navLogout" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
      <i class="fas fa-sign-out-alt"></i> Logout
    </a>
  </div>

  <!-- Main -->
  <div class="w3-main" style="margin-left:260px">
    <div class="w3-teal">
      <button class="w3-button w3-teal w3-xlarge w3-hide-large" onclick="w3_open()" style="padding: 16px;">&#9776;</button>
      <div class="w3-container">
        <div class="header-content">
          <h1 class="header-title">Timetable Generator</h1>
          <div class="user-info">
            <div class="user-avatar">A</div>
            <div>
              <div style="font-weight: 600; font-size: 14px;">Admin</div>
              <div style="font-size: 12px; opacity: 0.9;">System Administrator</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="content-wrapper">
      <div class="card">
        <div class="form-group">
          <label><i class="fas fa-user-tag"></i> Role</label>
          <select class="w3-select" id="roleSelect">
            <option value="">â€” Select Role â€”</option>
            <option value="lecturer">Lecturer</option>
            <option value="student">Student</option>
          </select>
        </div>

        <div class="form-group">
          <label><i class="fas fa-users"></i> Select Person</label>
          <input type="text" class="w3-input" id="searchInput" placeholder="Type to search name or ID..." disabled>
          <select class="w3-select" id="personSelect" style="margin-top: 8px;" disabled>
            <option value="">â€” Select role first â€”</option>
          </select>
        </div>

        <div style="margin-top: 20px;">
          <button class="btn btn-primary" id="generateBtn" disabled>
            <i class="fas fa-play"></i> Generate Timetable
          </button>
        </div>
      </div>

      <div class="now-highlight" id="nowHighlight">
        ðŸ•’ Currently in session: <span id="currentClass"></span>
      </div>

      <div id="timetableOutput" class="card" style="display:none;"></div>

      <div id="analysisOutput" class="card analysis-section" style="display:none;">
        <h3 style="margin: 0 0 16px 0; color: var(--utm-blue); display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-chart-line"></i> Timetable Analysis
        </h3>
        <div id="analysisContent"></div>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    // Auth check
    const rawSession = localStorage.getItem("TTMSFC_userSession");
    if (!rawSession) {
      alert("Please log in first.");
      window.location.replace("../index.html");
    }

    let user;
    try {
      user = JSON.parse(rawSession);
    } catch (e) {
      localStorage.removeItem("TTMSFC_userSession");
      window.location.replace("../index.html");
    }

    if (user.inferredRole !== "admin") {
      alert("Admin access required.");
      window.location.replace("../index.html");
    }

    document.getElementById("navLogout").onclick = function() {
      if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("TTMSFC_userSession");
        window.location.replace("../index.html");
      }
    };

    // DOM
    const roleSelect = document.getElementById('roleSelect');
    const searchInput = document.getElementById('searchInput');
    const personSelect = document.getElementById('personSelect');
    const generateBtn = document.getElementById('generateBtn');
    const timetableOutput = document.getElementById('timetableOutput');
    const nowHighlight = document.getElementById('nowHighlight');
    const currentClassEl = document.getElementById('currentClass');
    const analysisOutput = document.getElementById('analysisOutput');
    const analysisContent = document.getElementById('analysisContent');

    let realSessionId = null;
    let currentSesi = '';
    let currentSemester = '';
    let allPersons = [];

    // Get real session ID
    async function getRealSessionId() {
      const password = user.session_id || user.password || user.id;
      if (!password) throw new Error("No session ID found");

      const authUrl = `http://web.fc.utm.my/ttms/auth-admin.php?session_id=${encodeURIComponent(password)}`;
      const response = await fetch(authUrl);
      const text = await response.text();

      const patterns = [
        /name\s*=\s*["']session_id["']\s+value\s*=\s*["']([^"']+)/i,
        /value\s*=\s*["']([^"']+)["']\s+name\s*=\s*["']session_id["']/i,
        /"session_id"\s*:\s*"([^"]+)"/
      ];

      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) return match[1].trim();
      }
      
      const ids = text.match(/[A-Za-z0-9]{20,}/g);
      if (ids && ids.length > 0) return ids[0];
      
      throw new Error("Could not extract real session ID");
    }

    // Load lecturers - FIXED to load ALL lecturers
    async function loadLecturers(sesi, semester) {
      if (!realSessionId) realSessionId = await getRealSessionId();
      
      let allLecturers = [];
      let offset = 0;
      const limit = 1000;
      
      while (true) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah&session_id=${encodeURIComponent(realSessionId)}&sesi=${encodeURIComponent(sesi)}&semester=${encodeURIComponent(semester)}&limit=${limit}&offset=${offset}`;
        const res = await fetch(url);
        const text = await res.text();
        
        if (!text.trim()) break;
        
        let data;
        try { 
          data = JSON.parse(text); 
        } catch (e) { 
          break; 
        }
        
        const page = Array.isArray(data) ? data : (data ? [data] : []);
        if (page.length === 0) break;
        
        allLecturers.push(...page);
        
        if (page.length < limit) break;
        offset += limit;
      }
      
      return allLecturers
        .filter(l => l.no_pekerja && l.nama)
        .map(l => ({ 
          id: String(l.no_pekerja), 
          name: String(l.nama) 
        }));
    }

    // Load students
    async function loadStudents(sesi, semester) {
      if (!realSessionId) realSessionId = await getRealSessionId();
      let all = [];
      let offset = 0;
      const limit = 1000;
      while (all.length < 10000) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${encodeURIComponent(realSessionId)}&sesi=${encodeURIComponent(sesi)}&semester=${encodeURIComponent(semester)}&limit=${limit}&offset=${offset}`;
        const res = await fetch(url);
        const text = await res.text();
        if (!text.trim() || text.includes("The most simple ever")) break;
        let data;
        try { data = JSON.parse(text); } catch (e) { break; }
        const page = Array.isArray(data) ? data : (data ? [data] : []);
        if (page.length === 0) break;
        all.push(...page);
        if (page.length < limit) break;
        offset += limit;
      }
      return all.filter(s => s.no_matrik).map(s => ({ 
        id: String(s.no_matrik), 
        name: String(s.nama) 
      }));
    }

    // Set academic session defaults
    function getDefaultSessionAndSemester() {
      const month = new Date().getMonth() + 1;
      const year = new Date().getFullYear();
      const sesi = (month >= 2 && month <= 7) ? `${year}/${year + 1}` : `${year - 1}/${year}`;
      const semester = (month >= 2 && month <= 7) ? "2" : "1";
      return { sesi, semester };
    }

    // Role change handler
    roleSelect.addEventListener('change', async () => {
      const role = roleSelect.value;
      searchInput.disabled = !role;
      personSelect.disabled = true;
      generateBtn.disabled = true;
      personSelect.innerHTML = '<option>Loading...</option>';
      searchInput.value = '';

      if (!role) {
        personSelect.innerHTML = '<option>â€” Select role first â€”</option>';
        return;
      }

      const { sesi, semester } = getDefaultSessionAndSemester();
      currentSesi = sesi;
      currentSemester = semester;

      try {
        allPersons = role === 'lecturer' 
          ? await loadLecturers(sesi, semester)
          : await loadStudents(sesi, semester);

        renderPersonOptions(allPersons);
        personSelect.disabled = false;
        searchInput.disabled = false;
      } catch (err) {
        console.error(err);
        personSelect.innerHTML = '<option>Error loading data</option>';
      }
    });

    // Real-time search
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.trim().toLowerCase();
      if (!term) {
        renderPersonOptions(allPersons);
        return;
      }
      const filtered = allPersons.filter(p => {
        const name = (p.name || '').toLowerCase();
        const id = String(p.id || '').toLowerCase();
        return name.includes(term) || id.includes(term);
      });
      renderPersonOptions(filtered);
    });

    // Auto-generate when person is selected from dropdown
    personSelect.addEventListener('change', () => {
      if (personSelect.value && !generateBtn.disabled) {
        generateBtn.click();
      }
    });

    function renderPersonOptions(list) {
      if (list.length === 0) {
        personSelect.innerHTML = '<option>No matches found</option>';
        generateBtn.disabled = true;
        return;
      }
      personSelect.innerHTML = list.map(p => 
        `<option value="${p.id}">${p.name} (${p.id})</option>`
      ).join('');
      generateBtn.disabled = false;
      
      // Auto-generate timetable when first person is loaded
      if (list.length > 0) {
        setTimeout(() => {
          generateBtn.click();
        }, 100);
      }
    }

    // Generate timetable
    generateBtn.addEventListener('click', async () => {
      const personId = personSelect.value;
      const personName = personSelect.options[personSelect.selectedIndex].text;
      const role = roleSelect.value;

      timetableOutput.style.display = 'block';
      timetableOutput.innerHTML = `<div style="text-align:center;padding:20px;color:#003366;">Generating timetable for ${personName}...</div>`;
      nowHighlight.classList.remove('show');

      try {
        let timetableData = [];
        if (role === 'lecturer') {
          const subjUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah_subjek&no_pekerja=${encodeURIComponent(personId)}`;
          const subjects = await (await fetch(subjUrl)).json();
          const currentSubs = (Array.isArray(subjects) ? subjects : [subjects])
            .filter(s => s.sesi === currentSesi && String(s.semester) === currentSemester);

          for (const subj of currentSubs) {
            const jadUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}&kod_subjek=${encodeURIComponent(subj.kod_subjek)}&seksyen=${encodeURIComponent(subj.seksyen)}`;
            const jad = await (await fetch(jadUrl)).json();
            const entries = (Array.isArray(jad) ? jad : []).map(e => ({
              ...e,
              kod_subjek: subj.kod_subjek,
              nama_subjek: subj.nama_subjek,
              room: e.ruang?.nama_ruang_singkatan || e.ruang?.kod_ruang || 'â€”'
            }));
            timetableData.push(...entries);
          }
        } else {
          const subjUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${encodeURIComponent(personId)}`;
          const subjects = await (await fetch(subjUrl)).json();
          const currentSubs = (Array.isArray(subjects) ? subjects : [subjects])
            .filter(s => s.sesi === currentSesi && String(s.semester) === currentSemester);

          for (const subj of currentSubs) {
            const jadUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}&kod_subjek=${encodeURIComponent(subj.kod_subjek)}&seksyen=${encodeURIComponent(subj.seksyen)}`;
            const jad = await (await fetch(jadUrl)).json();
            const entries = (Array.isArray(jad) ? jad : []).map(e => ({
              ...e,
              kod_subjek: subj.kod_subjek,
              nama_subjek: subj.nama_subjek,
              room: e.ruang?.nama_ruang_singkatan || e.ruang?.kod_ruang || 'â€”'
            }));
            timetableData.push(...entries);
          }
        }

        if (role === 'lecturer') {
          renderTimetable(timetableData, personName, 'lecturer');
        } else {
          renderTimetable(timetableData, personName, 'student');
        }
        highlightCurrentClass(timetableData);
        generateAnalysis(timetableData, role);
      } catch (err) {
        timetableOutput.innerHTML = `<div class="card" style="background:#fef2f2;border-left:4px solid #ef4444;color:#991b1b;">
          <p><i class="fas fa-exclamation-triangle"></i> Error: ${err.message}</p>
        </div>`;
      }
    });

    // === UNIFIED TIMETABLE RENDERER ===
    function renderTimetable(entries, personName, role) {
      const days = [
        { id: 2, name: "MONDAY" },
        { id: 3, name: "TUESDAY" },
        { id: 4, name: "WEDNESDAY" },
        { id: 5, name: "THURSDAY" },
        { id: 6, name: "FRIDAY" }
      ];
      const slots = [
        { slot: 2, label: "08:00 â€“ 09:00" },
        { slot: 3, label: "09:00 â€“ 10:00" },
        { slot: 4, label: "10:00 â€“ 11:00" },
        { slot: 5, label: "11:00 â€“ 12:00" },
        { slot: 6, label: "12:00 â€“ 13:00" },
        { slot: 7, label: "13:00 â€“ 14:00" },
        { slot: 8, label: "14:00 â€“ 15:00" },
        { slot: 9, label: "15:00 â€“ 16:00" },
        { slot: 10, label: "16:00 â€“ 17:00" }
      ];

      // Build day-slot map
      const daySlotMap = {};
      days.forEach(d => {
        daySlotMap[d.id] = {};
        slots.forEach(s => { daySlotMap[d.id][s.slot] = []; });
      });
      
      entries.forEach(e => {
        if (daySlotMap[e.hari] && daySlotMap[e.hari][e.masa]) {
          daySlotMap[e.hari][e.masa].push(e);
        }
      });

      // Track cells to skip due to rowspan
      const skipMap = {};
      days.forEach(d => skipMap[d.id] = new Set());

      let html = `<div class="timetable-container"><div class="timetable-grid">`;
      
      // Header row
      html += `<div class="corner-cell">TIME</div>`;
      days.forEach(d => {
        html += `<div class="day-header">${d.name}</div>`;
      });

      // Time rows
      slots.forEach((s, i) => {
        html += `<div class="time-cell">${s.label}</div>`;
        
        days.forEach(d => {
          // Skip if this cell is part of a previous rowspan
          if (skipMap[d.id].has(s.slot)) return;
          
          const cellEntries = daySlotMap[d.id][s.slot] || [];
          
          if (cellEntries.length > 0) {
            const c = cellEntries[0];
            
            // Calculate rowspan by checking consecutive slots with same subject
            let spanLen = 1;
            for (let j = i + 1; j < slots.length; j++) {
              const nextSlot = slots[j].slot;
              const nextCell = daySlotMap[d.id][nextSlot] || [];
              if (nextCell.length === 1 && 
                  nextCell[0].kod_subjek === c.kod_subjek && 
                  nextCell[0].seksyen === c.seksyen) {
                spanLen++;
                skipMap[d.id].add(nextSlot);
              } else {
                break;
              }
            }
            
            // Display format based on role
            const sectionLabel = role === 'lecturer' ? `(Sec ${c.seksyen})` : '';
            
            html += `
              <div class="grid-cell" style="grid-row: span ${spanLen}">
                <div class="class-item">
                  <div class="class-code">${c.kod_subjek} ${sectionLabel}</div>
                  <div class="class-name">${c.nama_subjek}</div>
                  <div class="class-room"><i class="fas fa-door-open"></i> ${c.room}</div>
                </div>
              </div>`;
          } else {
            html += `<div class="grid-cell"></div>`;
          }
        });
      });
      
      html += `</div></div>`;

      const roleLabel = role === 'lecturer' ? 'Lecturer' : 'Student';
      const summary = `<div class="summary-bar">${roleLabel} Timetable: ${personName} â€¢ ${currentSesi} Semester ${currentSemester}</div>`;
      timetableOutput.innerHTML = html + summary;
    }

    function highlightCurrentClass(data) {
      const now = new Date();
      const currentDay = now.getDay();
      const ttDay = currentDay === 0 ? 7 : currentDay + 1;
      const currentHour = now.getHours();
      const hourToSlot = {8:2,9:3,10:4,11:5,12:6,13:7,14:8,15:9,16:10};
      const currentSlot = hourToSlot[currentHour];

      if (currentSlot && [2,3,4,5,6].includes(ttDay)) {
        const entry = data.find(e => e.hari === ttDay && e.masa === currentSlot);
        if (entry) {
          currentClassEl.textContent = `${entry.kod_subjek} ${entry.nama_subjek} â€” Room ${entry.room}`;
          nowHighlight.classList.add('show');
          return;
        }
      }
      currentClassEl.textContent = "No class in session.";
      nowHighlight.classList.add('show');
    }

    // === GENERATE ANALYSIS ===
    function generateAnalysis(data, role) {
      if (!data || data.length === 0) {
        analysisOutput.style.display = 'none';
        return;
      }

      // Calculate statistics
      const dayNames = {2:"Monday", 3:"Tuesday", 4:"Wednesday", 5:"Thursday", 6:"Friday"};
      const timeLabels = {
        2: "08:00-09:00", 3: "09:00-10:00", 4: "10:00-11:00",
        5: "11:00-12:00", 6: "12:00-13:00", 7: "13:00-14:00",
        8: "14:00-15:00", 9: "15:00-16:00", 10: "16:00-17:00"
      };

      // Total classes
      const totalClasses = data.length;

      // Classes per day
      const dayCount = {};
      data.forEach(entry => {
        const day = dayNames[entry.hari] || 'Unknown';
        dayCount[day] = (dayCount[day] || 0) + 1;
      });

      // Classes per time slot
      const timeCount = {};
      data.forEach(entry => {
        const time = timeLabels[entry.masa] || 'Unknown';
        timeCount[time] = (timeCount[time] || 0) + 1;
      });

      // Room usage
      const roomCount = {};
      data.forEach(entry => {
        const room = entry.room || 'Unknown';
        roomCount[room] = (roomCount[room] || 0) + 1;
      });

      // Unique subjects
      const uniqueSubjects = new Set(data.map(e => e.kod_subjek)).size;

      // Find busiest day
      const busiestDay = Object.entries(dayCount).sort((a,b) => b[1] - a[1])[0];
      const maxDayCount = Math.max(...Object.values(dayCount));

      // Average classes per day
      const avgClassesPerDay = (totalClasses / Object.keys(dayCount).length).toFixed(1);

      // Peak time
      const peakTime = Object.entries(timeCount).sort((a,b) => b[1] - a[1])[0];

      // Free days
      const allDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
      const freeDays = allDays.filter(day => !dayCount[day]);

      let html = `<div class="analysis-grid">`;

      // Card 1: Total Classes
      html += `
        <div class="stat-card">
          <h4><i class="fas fa-calendar-check"></i> Total Classes</h4>
          <div class="stat-value">${totalClasses}</div>
          <div class="stat-label">classes per week</div>
        </div>`;

      // Card 2: Unique Subjects
      if (role === 'lecturer') {
        html += `
          <div class="stat-card">
            <h4><i class="fas fa-book"></i> Teaching Load</h4>
            <div class="stat-value">${uniqueSubjects}</div>
            <div class="stat-label">unique subject${uniqueSubjects !== 1 ? 's' : ''}</div>
          </div>`;
      } else {
        html += `
          <div class="stat-card">
            <h4><i class="fas fa-book"></i> Enrolled Subjects</h4>
            <div class="stat-value">${uniqueSubjects}</div>
            <div class="stat-label">subject${uniqueSubjects !== 1 ? 's' : ''} this semester</div>
          </div>`;
      }

      // Card 3: Average Classes
      html += `
        <div class="stat-card">
          <h4><i class="fas fa-chart-bar"></i> Daily Average</h4>
          <div class="stat-value">${avgClassesPerDay}</div>
          <div class="stat-label">classes per day</div>
        </div>`;

      // Card 4: Busiest Day
      html += `
        <div class="stat-card">
          <h4><i class="fas fa-fire"></i> Busiest Day</h4>
          <div class="stat-value" style="font-size: 24px;">${busiestDay[0]}</div>
          <div class="stat-label">${busiestDay[1]} class${busiestDay[1] !== 1 ? 'es' : ''}</div>
        </div>`;

      html += `</div>`;

      // Weekly Distribution
      html += `
        <div class="stat-card" style="margin-top: 20px;">
          <h4><i class="fas fa-calendar-week"></i> Weekly Distribution</h4>
          <div style="margin-top: 16px;">`;
      
      allDays.forEach(day => {
        const count = dayCount[day] || 0;
        const percentage = maxDayCount > 0 ? (count / maxDayCount * 100) : 0;
        html += `
          <div class="day-bar">
            <div class="day-label">${day}</div>
            <div class="bar-container">
              <div class="bar-fill" style="width: ${percentage}%">${count}</div>
            </div>
          </div>`;
      });

      html += `</div></div>`;

      // Peak Times
      html += `
        <div class="stat-card" style="margin-top: 20px;">
          <h4><i class="fas fa-clock"></i> Peak Times</h4>
          <div class="time-slots">`;
      
      Object.entries(timeCount)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 5)
        .forEach(([time, count]) => {
          html += `
            <div class="time-slot-item">
              <span class="time-slot-time">${time}</span>
              <span class="time-slot-count">${count} class${count !== 1 ? 'es' : ''}</span>
            </div>`;
        });

      html += `</div></div>`;

      // Room Usage
      const topRooms = Object.entries(roomCount)
        .filter(([room]) => room !== 'â€”')
        .sort((a,b) => b[1] - a[1])
        .slice(0, 8);

      if (topRooms.length > 0) {
        html += `
          <div class="stat-card" style="margin-top: 20px;">
            <h4><i class="fas fa-door-open"></i> Room Usage</h4>
            <div class="rooms-list">`;
        
        topRooms.forEach(([room, count]) => {
          html += `
            <div class="room-item">
              <span class="room-name">${room}</span>
              <span class="room-count">${count}x</span>
            </div>`;
        });

        html += `</div></div>`;
      }

      // Free Days Notice
      if (freeDays.length > 0) {
        html += `
          <div class="stat-card" style="margin-top: 20px; border-left-color: #10b981;">
            <h4><i class="fas fa-smile"></i> Free Days</h4>
            <div style="margin-top: 8px; color: #10b981; font-weight: 600; font-size: 14px;">
              ${freeDays.join(', ')}
            </div>
            <div class="stat-label" style="margin-top: 4px;">No classes scheduled</div>
          </div>`;
      }

      analysisContent.innerHTML = html;
      analysisOutput.style.display = 'block';
    }

    function w3_open() {
      document.getElementById("mySidebar").style.display = "block";
    }
  </script>
</body>
</html>
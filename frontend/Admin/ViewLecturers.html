<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>TTMS - View Lecturers</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --utm-blue: #003366;
      --utm-gold: #C9A85C;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Sidebar */
    .w3-sidebar {
      background: linear-gradient(180deg, var(--utm-blue) 0%, #002244 100%) !important;
      box-shadow: 2px 0 12px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .sidebar-logo {
      font-size: 28px;
      color: var(--utm-gold);
      margin-bottom: 8px;
    }

    .sidebar-title {
      color: white;
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      letter-spacing: 0.5px;
    }

    .sidebar-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      margin: 4px 0 0;
    }

    .w3-sidebar .w3-bar-item {
      color: rgba(255,255,255,0.9) !important;
      border-bottom: none;
      padding: 16px 20px;
      transition: all 0.3s ease;
      font-weight: 500;
      position: relative;
    }

    .w3-sidebar .w3-bar-item:hover {
      background-color: rgba(201, 168, 92, 0.15) !important;
      color: white !important;
      padding-left: 28px;
    }

    .w3-sidebar .w3-bar-item.active {
      background-color: var(--utm-gold) !important;
      color: var(--utm-blue) !important;
      font-weight: 600;
    }

    .w3-sidebar .w3-bar-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    /* Header */
    .w3-teal {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
    }

    .header-title {
      margin: 0;
      color: white;
      font-size: 28px;
      font-weight: 700;
    }

    /* Main Content */
    .w3-main {
      background-color: var(--light-bg);
      min-height: 100vh;
      transition: margin-left 0.3s;
    }

    .content-wrapper {
      padding: 32px;
      max-width: 1400px;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-color);
    }

    .card-header i {
      font-size: 24px;
      color: var(--utm-blue);
    }

    .card-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Form Controls */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .form-group label i {
      color: var(--utm-blue);
    }

    .w3-input, .w3-select {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      background: white;
      transition: border-color 0.2s;
    }

    .w3-input:focus, .w3-select:focus {
      outline: none;
      border-color: var(--utm-blue);
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Stats & Debug */
    .stats-card {
      background: #e8f5e9;
      border-left: 4px solid var(--success);
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
    }

    .debug-card {
      background: #f0f8ff;
      border-left: 4px solid var(--utm-blue);
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
      display: none !important; /*hide the div*/
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    table.w3-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin: 0;
      font-size: 14px;
    }

    table.w3-table thead tr {
      background: linear-gradient(135deg, var(--utm-blue) 0%, #004080 100%);
      color: white;
    }

    table.w3-table th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    table.w3-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    table.w3-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .highlight {
      background-color: #fff9c4 !important;
    }

    .lecturer-link {
      color: var(--utm-blue);
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
    }

    /* Panels */
    .info-panel {
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      font-size: 14px;
    }

    .panel-yellow {
      background: #fffbeb;
      border-left: 4px solid var(--warning);
      color: #713f12;
    }

    .panel-red {
      background: #fef2f2;
      border-left: 4px solid var(--error);
      color: #991b1b;
    }

    .panel-blue {
      background: #f0f9ff;
      border-left: 4px solid var(--utm-blue);
      color: var(--utm-blue);
      display: none !important; /*hide the div*/
    }

    /* Loading & Error */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px;
      gap: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-color);
      border-top-color: var(--utm-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .error-container {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-left: 4px solid var(--error);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .error-container h4 {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 0 8px 0;
      color: #991b1b;
      font-size: 16px;
    }

    .error-container p {
      margin: 0;
      color: #991b1b;
      font-size: 14px;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
      background: #fafafa;
      border-radius: 8px;
      margin: 24px 0;
    }

    .refresh-info {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    @media (max-width: 768px) {
      .content-wrapper {
        padding: 20px;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
	
	.tag {
	  display: inline-block;
	  padding: 6px 10px;
	  border-radius: 999px;
	  font-weight: 700;
	  font-size: 12px;
	  border: 1px solid var(--border-color);
	  background: white;
	}
	.tag.hot {
	  border-color: #fecaca;
	  background: #fff1f2;
	  color: #991b1b;
	}
	.tag.zero {
	  border-color: #bfdbfe;
	  background: #eff6ff;
	  color: #1d4ed8;
	}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="w3-sidebar w3-bar-block w3-collapse w3-card" style="width:260px;" id="mySidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <h2 class="sidebar-title">TTMS</h2>
      <p class="sidebar-subtitle">Timetable Management System</p>
    </div>
    
    <a href="Admin.html" class="w3-bar-item w3-button">
      <i class="fas fa-home"></i> Dashboard
    </a>
    <a href="ViewLecturers.html" class="w3-bar-item w3-button active">
      <i class="fas fa-chalkboard-teacher"></i> Lecturers
    </a>
    <a href="ViewStudents.html" class="w3-bar-item w3-button">
      <i class="fas fa-user-graduate"></i> Students
    </a>
    <a href="ViewSubjects.html" class="w3-bar-item w3-button">
      <i class="fas fa-book-open"></i> Subjects
    </a>
    <a href="RoomUtilization.html" class="w3-bar-item w3-button">
      <i class="fas fa-door-open"></i> Room Utilization
    </a>
    <a href="Reports.html" class="w3-bar-item w3-button">
      <i class="fas fa-chart-bar"></i> Reports
    </a>
    <a href="#" class="w3-bar-item w3-button" id="navLogout" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
      <i class="fas fa-sign-out-alt"></i> Logout
    </a>
  </div>

  <!-- Main Content -->
  <div class="w3-main" style="margin-left:260px">
    <div class="w3-teal">
      <button class="w3-button w3-teal w3-xlarge w3-hide-large" onclick="w3_open()" style="padding: 16px;">&#9776;</button>
      <div class="w3-container">
        <div class="header-content">
          <h1 class="header-title">View Lecturers</h1>
        </div>
      </div>
    </div>

    <div class="content-wrapper">
      <!-- Description Card -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-search"></i>
          <h3>Search & Filter Lecturers</h3>
        </div>
        <p>Load lecturer data by session and semester. Click on a lecturer name to view assigned subjects.</p>
      </div>

      <!-- Search Controls -->
      <div class="card">
        <div class="form-row">
          <div class="form-group">
            <label for="sessionSelect">
              <i class="fas fa-calendar-alt"></i> Academic Session
            </label>
            <select class="w3-select" id="sessionSelect"></select>
          </div>
          <div class="form-group">
            <label for="semesterSelect">
              <i class="fas fa-book"></i> Semester
            </label>
            <select class="w3-select" id="semesterSelect">
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Special Semester</option>
            </select>
          </div>
          <div class="form-group">
            <label for="searchBySelect">
              <i class="fas fa-filter"></i> Search By
            </label>
            <select class="w3-select" id="searchBySelect">
              <option value="name">Lecturer Name</option>
              <option value="staffId">Staff ID</option>
              <option value="both">Both Name & ID</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <label for="searchInput">
              <i class="fas fa-search"></i> Search Term
            </label>
            <input type="text" class="w3-input" id="searchInput" placeholder="Enter lecturer name or staff ID...">
          </div>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
          <button class="btn btn-primary" id="loadLecturersBtn">
            <i class="fas fa-sync-alt"></i> Load Lecturers
          </button>
          <button class="btn btn-success" id="applySearchBtn">
            <i class="fas fa-search"></i> Apply Search
          </button>
          <button class="btn btn-secondary" id="clearSearchBtn">
            <i class="fas fa-times"></i> Clear Search
          </button>
		  <button class="btn btn-info" id="showWorkloadBtn">
			<i class="fas fa-chart-line"></i> Show Workload Table
		  </button>
        </div>
        <div class="refresh-info">
          <i class="fas fa-info-circle"></i> Data auto-refreshes every 25 minutes
        </div>
      </div>

      
      <!-- Auth Info -->
      <div class="card debug-card">
        <h4><i class="fas fa-key"></i> Your Login Info</h4>
        <p><strong>Account:</strong> <span id="loginDisplay">...</span></p>
        <p><strong>Password (Session ID):</strong> <span id="sessionIdDisplay">...</span></p>
      </div>

      <div class="card panel-blue">
        <h4><i class="fas fa-shield-alt"></i> Real Session ID Used for Data</h4>
        <p><strong>Session ID:</strong> <span id="sessionUsedDisplay">Loading...</span></p>
      </div>
      
      
      <!-- Loading -->
      <div id="loadingSpinner" class="card" style="display:none;">
        <div class="loading-container">
          <div class="spinner"></div>
          <div class="loading-text">Loading lecturers...</div>
        </div>
      </div>

      <!-- Error -->
      <div id="errorContainer" class="error-container" style="display:none;">
        <h4>
          <i class="fas fa-exclamation-triangle"></i>
          <span id="errorTitle">Error</span>
        </h4>
        <p id="errorMessage"></p>
      </div>

      <!-- Results -->
      <div id="lecturerTableContainer" class="card">
        <div class="empty-state">
          <i class="fas fa-chalkboard-teacher" style="font-size: 48px; opacity: 0.6;"></i>
          <p>Click "Load Lecturers" to begin</p>
        </div>
      </div>
	  
	  <!-- Workload Panel -->
		<div id="workloadPanel" class="card" style="display:none;">
		  <div class="card-header">
			<i class="fas fa-chart-line"></i>
			<h3>Lecturer Workload (Analytics)</h3>
		  </div>
		  <p class="w3-small" style="color: var(--text-secondary); margin-top:0;">
			Ranking by Students / Subjects / Sections (TTMS: <code>bil_pelajar</code>, <code>bil_subjek</code>, <code>bil_seksyen</code>)
		  </p>
		  <span class="tag hot"><i class="fas fa-fire"></i> Student > 120</span>
		  <div class="table-wrapper" id="workloadTableWrap"></div>
		</div>
		
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    // Sidebar
    function w3_open() {
      document.getElementById("mySidebar").style.display = "block";
    }

    // Auth
    const rawSession = localStorage.getItem("TTMSFC_userSession");
    if (!rawSession) {
      alert("Please log in first.");
      window.location.replace("../index.html");
    }

    let user;
    try {
      user = JSON.parse(rawSession);
    } catch (e) {
      localStorage.removeItem("TTMSFC_userSession");
      window.location.replace("../index.html");
    }

    if (user.inferredRole !== "admin") {
      alert("Admin access required.");
      window.location.replace("../index.html");
    }

    document.getElementById("loginDisplay").textContent = user.login || "‚Äî";
    document.getElementById("sessionIdDisplay").textContent = user.session_id || "‚Äî";

    document.getElementById("navLogout").onclick = function() {
      if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("TTMSFC_userSession");
        localStorage.removeItem("TTMSFC_adminAuth");
        window.location.replace("../index.html");
      }
    };

    // ===== LECTURER LOGIC =====
    let autoRefreshInterval = null;
    let currentLecturerData = [];
	let currentDisplayedLecturerData = [];
    let currentSessionId = null;
    let currentSesi = '';
    let currentSemester = '';
	const month = new Date().getMonth() + 1;

    function generateAcademicYears() {
      const currentYear = new Date().getFullYear();
      const years = [];
	  const latestStartYear = (month >= 2 && month <= 7) ? currentYear : (currentYear - 1);
	  for (let i = latestStartYear ; i >= latestStartYear - 5; i--) {
		years.push(`${i}/${i + 1}`);
	  }
      return years;
    }

    function filterLecturers(data, searchTerm, searchBy) {
      if (!searchTerm.trim()) return data;
      const term = searchTerm.toLowerCase().trim();
      return data.filter(lect => {
        switch(searchBy) {
          case 'name': return (lect.nama || '').toLowerCase().includes(term);
          case 'staffId': return (lect.no_pekerja || '').toString().includes(term);
          case 'both': return (lect.nama || '').toLowerCase().includes(term) || (lect.no_pekerja || '').toString().includes(term);
          default: return true;
        }
      });
    }

    function showLecturerSubjects(staffId, realSessionId, sesi, semester) {
      if (!realSessionId) {
        alert("Real session not loaded yet. Please click 'Load Lecturers' first.");
        return;
      }

      const container = document.getElementById("lecturerTableContainer");
      container.innerHTML = `<div class="empty-state">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Loading subjects for staff ID: ${staffId}<br>Session <strong>${sesi}</strong>, Semester <strong>${semester}</strong></p>
        </div>
      </div>`;

      const subjectUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah_subjek&session_id=${encodeURIComponent(realSessionId)}&no_pekerja=${encodeURIComponent(staffId)}`;

      fetch(subjectUrl)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.text();
        })
        .then(text => {
          if (!text.trim()) throw new Error("Empty response");
          let subjects = JSON.parse(text);
          if (!Array.isArray(subjects)) subjects = [subjects];

          const filteredSubjects = subjects.filter(subj =>
            (subj.sesi || '').toString() === sesi.toString() &&
            (subj.semester || '').toString() === semester.toString()
          );

          if (filteredSubjects.length === 0) {
            container.innerHTML = `<div class="card panel-yellow">
              <h4><i class="fas fa-info-circle"></i> No Subjects Found</h4>
              <p>Lecturer <code>${staffId}</code> has no subjects in <strong>${sesi} Semester ${semester}</strong>.</p>
              <button class="btn btn-primary" onclick="initLecturersPageWithFilters('${sesi}', '${semester}');">‚Üê Back to Lecturers</button>
            </div>`;
            return;
          }

          let html = `<div class="card panel-blue">
            <h4><i class="fas fa-book"></i> Subjects for Staff ID: ${staffId}</h4>
            <p><strong>Session:</strong> ${sesi} | <strong>Semester:</strong> ${semester}</p>
            <button class="btn btn-primary" onclick="initLecturersPageWithFilters('${sesi}', '${semester}');">‚Üê Back to Lecturers</button>
          </div>
          <div class="table-wrapper">
            <table class="w3-table w3-striped w3-bordered">
              <thead><tr>
                <th>No.</th><th>Subject Code</th><th>Subject Name</th>
                <th>Section</th><th>Session</th><th>Semester</th><th>Students</th>
              </tr></thead>
              <tbody>`;

          filteredSubjects.forEach((subj, i) => {
            html += `<tr>
              <td>${i + 1}</td>
              <td>${subj.kod_subjek || '‚Äî'}</td>
              <td>${subj.nama_subjek || '‚Äî'}</td>
              <td>${subj.seksyen || '‚Äî'}</td>
              <td>${subj.sesi || '‚Äî'}</td>
              <td>${subj.semester || '‚Äî'}</td>
              <td>${subj.bil_pelajar || 0}</td>
            </tr>`;
          });

          html += `</tbody></table></div>`;
          container.innerHTML = html;
        })
        .catch(err => {
          container.innerHTML = `<div class="card panel-red">
            <h4><i class="fas fa-exclamation-triangle"></i> Failed to Load Subjects</h4>
            <p><strong>Staff ID:</strong> ${staffId}</p>
            <p><strong>Filter:</strong> ${sesi} Semester ${semester}</p>
            <p><strong>Error:</strong> ${err.message}</p>
            <button class="btn btn-primary" onclick="initLecturersPageWithFilters('${sesi}', '${semester}');">‚Üê Back to Lecturers</button>
          </div>`;
        });
    }

    function initLecturersPageWithFilters(sesi, semester) {
	  initLecturersPage();

	  setTimeout(() => {
		if (sesi) document.getElementById("sessionSelect").value = sesi;
		if (semester) document.getElementById("semesterSelect").value = semester;

		document.getElementById("loadLecturersBtn").click();
	  }, 150);
	}

	
	function escapeHtml(s) {
	  return (s ?? "").toString()
		.replaceAll("&","&amp;").replaceAll("<","&lt;")
		.replaceAll(">","&gt;")
		.replaceAll('"',"&quot;")
		.replaceAll("'","&#039;");
	}

	function normalizeLecturer(r) {
	  const name = r.nama || "‚Äî";
	  const staffId = String(r.no_pekerja ?? "‚Äî");
	  const subjects = Number(r.bil_subjek || 0);
	  const sections = Number(r.bil_seksyen || 0);
	  const students = Number(r.bil_pelajar || 0);

	  const avg = sections > 0 ? (students / sections) : 0;
	  return { name, staffId, subjects, sections, students, avg };
	}


	function renderWorkloadTableFromCurrentData() {
	  if (!Array.isArray(currentLecturerData) || currentLecturerData.length === 0) {
		alert("Please load lecturers first.");
		return;
	  }

	  const base = (Array.isArray(currentDisplayedLecturerData) && currentDisplayedLecturerData.length) 
	  ? currentDisplayedLecturerData : currentLecturerData;
	  
	  const rows = base.map(normalizeLecturer);


	  // If you want workload table to follow your search filter, apply it here:
	  const term = (document.getElementById("searchInput")?.value || "").trim().toLowerCase();
	  const searchBy = document.getElementById("searchBySelect")?.value || "name";

	  const filtered = term
		? rows.filter(r => {
			const nameOk = r.name.toLowerCase().includes(term);
			const idOk = String(r.staffId ?? "").toLowerCase().includes(term);
			if (searchBy === "name") return nameOk;
			if (searchBy === "staffId") return idOk;
			return nameOk || idOk; // both
		  })
		: rows;

	  // Sort by students (descending)
	  const sorted = [...filtered].sort((a,b) => b.students - a.students);

	  const overloadThreshold = 120; // change if you want

	  const html = `
		<table class="w3-table w3-striped w3-bordered">
		  <thead>
			<tr>
			  <th>#</th>
			  <th>Lecturer</th>
			  <th>Staff ID</th>
			  <th>Students</th>
			  <th>Subjects</th>
			  <th>Sections</th>
			  <th>Avg Students / Sections</th>
			  <th>Flag</th>
			</tr>
		  </thead>
		  <tbody>
			${sorted.map((r, i) => {
			  const flag =r.students === 0
				? `<span class="tag zero"><i class="fas fa-user-slash"></i> 0 </span>`
				:(r.students >= overloadThreshold
					?`<span class="tag hot"><i class="fas fa-fire"></i> </span>`
					: `<span class="tag"><i class="fas fa-check"></i> OK</span>`);
			  return `
				<tr>
				  <td>${i + 1}</td>
				  <td><b>${escapeHtml(r.name)}</b></td>
				  <td>${escapeHtml(r.staffId)}</td>
				  <td><b>${r.students}</b></td>
				  <td>${r.subjects}</td>
				  <td>${r.sections}</td>
				  <td>${r.avg.toFixed(1)}</td>
				  <td>${flag}</td>
				</tr>
			  `;
			}).join("")}
		  </tbody>
		</table>
	  `;

	  document.getElementById("workloadTableWrap").innerHTML =
		sorted.length ? html : `<div class="empty-state"><p>No data to analyze.</p></div>`;

	  // show panel
	  document.getElementById("workloadPanel").style.display = "block";
	  document.getElementById("workloadPanel").scrollIntoView({ behavior: "smooth", block: "start" });
	}


    function initLecturersPage() {
      clearAutoRefresh();
	  const month = new Date().getMonth() + 1;
      const academicYears = generateAcademicYears();
      const currentYear = new Date().getFullYear();
      const defaultSession = (month >= 2 && month <=7) ? `${currentYear}/${currentYear + 1}` : `${currentYear - 1}/${currentYear}`  ;

      document.getElementById("sessionSelect").innerHTML = academicYears.map(year => 
        `<option value="${year}" ${year === defaultSession ? 'selected' : ''}>${year}</option>`
      ).join('');
	  
	  
	  document.getElementById("semesterSelect").value = (month >= 2 && month <=7) ? "2" : "1";
      document.getElementById("loadLecturersBtn").onclick = fetchLecturerData;
      document.getElementById("applySearchBtn").onclick = applySearch;
      document.getElementById("clearSearchBtn").onclick = clearSearch;
	  document.getElementById("showWorkloadBtn").onclick = renderWorkloadTableFromCurrentData;

      document.getElementById("searchInput").addEventListener('keypress', e => { if (e.key === 'Enter') applySearch(); });

      function fetchLecturerData() {
        currentSesi = document.getElementById("sessionSelect").value;
        currentSemester = document.getElementById("semesterSelect").value;
        document.getElementById("lecturerTableContainer").innerHTML = `<div class="empty-state">
          <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading lecturers for ${currentSesi} Semester ${currentSemester}...</p>
          </div>
        </div>`;

        const password = user.session_id || user.password || user.id;
        if (!password) {
          document.getElementById("lecturerTableContainer").innerHTML = `<div class="card panel-red">Invalid session: Session ID not found.</div>`;
          return;
        }

        const authUrl = `http://web.fc.utm.my/ttms/auth-admin.php?session_id=${encodeURIComponent(password)}`;
        fetch(authUrl)
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.text();
          })
          .then(text => {
            const patterns = [/name\s*=\s*["']session_id["']\s+value\s*=\s*["']([^"']+)/i, /value\s*=\s*["']([^"']+)["']\s+name\s*=\s*["']session_id["']/i, /"session_id"\s*:\s*"([^"]+)"/];
            let realSessionId = null;
            for (const pattern of patterns) {
              const match = text.match(pattern);
              if (match && match[1]) { realSessionId = match[1].trim(); break; }
            }
            if (!realSessionId) throw new Error("Could not extract real session ID.");
            currentSessionId = realSessionId;
            document.getElementById("sessionUsedDisplay").textContent = realSessionId;

            const dataUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah&session_id=${encodeURIComponent(realSessionId)}&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}`;
            return fetch(dataUrl);
          })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.text();
          })
          .then(text => {
            if (!text.trim()) throw new Error("Empty response");
            let data = JSON.parse(text);
            if (!Array.isArray(data)) data = [data];
            currentLecturerData = data;
            renderLecturerTable(data);
			currentDisplayedLecturerData = data;
			// If workload panel is open, refresh it too
			if (document.getElementById("workloadPanel").style.display !== "none") {
			  renderWorkloadTableFromCurrentData();
			}
            clearAutoRefresh();
            autoRefreshInterval = setInterval(fetchLecturerData, 25 * 60 * 1000);
          })
          .catch(err => {
            document.getElementById("lecturerTableContainer").innerHTML = `<div class="card panel-red">
              <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Lecturers</h4>
              <p><strong>Session:</strong> ${currentSesi} | <strong>Semester:</strong> ${currentSemester}</p>
              <p><strong>Error:</strong> ${err.message}</p>
            </div>`;
          });
      }

      function renderLecturerTable(data, searchTerm = '', searchBy = 'name') {
        const container = document.getElementById("lecturerTableContainer");
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = `<div class="card panel-yellow">No lecturers found for the selected session.</div>`;
          return;
        }

        const stats = `<div class="stats-card">
          <strong>üìä ${data.length} lecturer(s) found</strong>${searchTerm ? ` ‚Ä¢ Matching: "${searchTerm}"` : ''}
        </div>`;

        let html = `<div class="table-wrapper"><table class="w3-table w3-striped w3-bordered">
          <thead><tr>
            <th>No.</th><th>Lecturer Name</th><th>Staff ID</th>
            <th>Subjects</th><th>Sections</th><th>Students</th>
          </tr></thead>
          <tbody>`;

        data.forEach((lect, i) => {
          const name = lect.nama || '‚Äî';
          const staffId = lect.no_pekerja || '‚Äî';
          const shouldHighlight = searchTerm && filterLecturers([lect], searchTerm, searchBy).length > 0;
          const displayName = staffId !== '‚Äî' ? `<a class="lecturer-link" data-staff-id="${staffId}">${name}</a>` : name;
          html += `<tr ${shouldHighlight ? 'class="highlight"' : ''}>
            <td>${i + 1}</td>
            <td>${displayName}</td>
            <td>${staffId}</td>
            <td>${lect.bil_subjek || 0}</td>
            <td>${lect.bil_seksyen || 0}</td>
            <td>${lect.bil_pelajar || 0}</td>
          </tr>`;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = stats + html;

        document.querySelectorAll(".lecturer-link").forEach(link => {
          link.addEventListener("click", function() {
            const staffId = this.getAttribute("data-staff-id");
            showLecturerSubjects(staffId, currentSessionId, currentSesi, currentSemester);
          });
        });
      }

      function applySearch() {
        const searchTerm = document.getElementById("searchInput").value;
        const searchBy = document.getElementById("searchBySelect").value;
        if (!currentLecturerData.length) { alert("Please load lecturers first!"); return; }
        const filteredData = filterLecturers(currentLecturerData, searchTerm, searchBy);
		currentDisplayedLecturerData = filteredData;
        renderLecturerTable(filteredData, searchTerm, searchBy);
      }

      function clearSearch() {
        document.getElementById("searchInput").value = '';
        if (currentLecturerData.length) renderLecturerTable(currentLecturerData);
		currentDisplayedLecturerData = currentLecturerData;
      }
    }

    function clearAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    // Initialize
    //initLecturersPage();
    //Auto click the btn
    window.addEventListener("DOMContentLoaded", () => {
      initLecturersPage();
      document.getElementById("loadLecturersBtn").click(); // auto-load lecturers
    });

  </script>
</body>
</html>
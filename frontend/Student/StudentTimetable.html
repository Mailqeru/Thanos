<div class="timetable-container">
  <h3>My Class Schedule</h3>

  <div class="filters">
    <div class="filter-group">
      <label for="sessionSelect">Session</label>
      <select id="sessionSelect">
        <option value="">Loading...</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="semesterSelect">Semester</label>
      <select id="semesterSelect">
        <option value="">Select session first</option>
      </select>
    </div>

    <div class="filter-group">
      <label>&nbsp;</label>
      <button id="loadTimetableBtn">Load Timetable</button>
    </div>
  </div>

  <div id="timetableContent">
    <div class="loading">Loading your enrolled sessions...</div>
  </div>
</div>

<style>
  .timetable-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 16px;
  }

  .timetable-container h3 {
    color: #003366; /* UTM blue */
    margin-bottom: 24px;
    font-weight: 600;
    font-size: 24px;
    text-align: center;
  }

  .filters {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #444;
    font-size: 14px;
  }

  .filter-group select,
  .filter-group button {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    background: white;
    color: #333;
    transition: all 0.3s ease;
  }

  .filter-group button {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0, 51, 102, 0.3);
  }

  /* ===== DESKTOP TIMETABLE GRID ===== */
  .desktop-timetable {
    display: block;
  }

  .desktop-grid {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid #eaeef5;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: 100px repeat(9, 1fr);
  }

  /* NEW: Updated Day Label for Daily Hours */
  .day-label {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
    display: flex;
    flex-direction: column; /* Stack Day and Hours */
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border-right: 1px solid rgba(255,255,255,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    text-align: center;
  }

  .day-hours-subtext {
    font-size: 10px;
    font-weight: 400;
    opacity: 0.8;
    margin-top: 4px;
    text-transform: none;
  }

  .time-label, .corner-cell {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    font-weight: 700;
    font-size: 13px;
    text-align: center;
    padding: 12px 8px;
    border-right: 1px solid rgba(255,255,255,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }

  .grid-cell {
    grid-column: span var(--span, 1);
    min-height: 100px;
    border-right: 1px solid #eee;
    border-bottom: 1px solid #eee;
  }

  .grid-cell.empty {
    background: #fafbff;
  }

  .empty-cell::before {
    content: "â€”";
    color: #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }

  .class-item {
    background: #eef5ff;
    border-left: 5px solid #003366;
    padding: 8px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    box-sizing: border-box;
  }

  .class-code {
    font-weight: 700;
    color: #003366;
    font-size: 13px;
  }

  /* NEW: Subject Name Styling */
  .class-name {
    font-size: 10px;
    color: #555;
    margin-bottom: 4px;
    font-style: italic;
    line-height: 1.1;
  }

  .class-room, .class-lecturer {
    color: #666;
    font-size: 11px;
  }

  /* ===== MOBILE TIMETABLE LIST ===== */
  .mobile-timetable {
    display: none;
  }

  .day-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 16px;
    overflow: hidden;
    border: 1px solid #eaeef5;
  }

  .day-header {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    padding: 14px 16px;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
  }

  .time-slot-mobile {
    padding: 16px;
    border-bottom: 1px solid #eee;
    display: flex;
    gap: 12px;
  }

  .class-item-mobile {
    background: #eef5ff;
    border-left: 4px solid #003366;
    padding: 12px;
    border-radius: 8px;
    width: 100%;
  }

  .summary {
    margin-top: 20px;
    padding: 14px 20px;
    background-color: #f0f5ff;
    border-left: 4px solid #003366;
    font-weight: 600;
    color: #003366;
    border-radius: 0 8px 8px 0;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .desktop-timetable { display: none; }
    .mobile-timetable { display: block; }
  }
</style>

<script>
  (function() {
    console.log("ðŸ“… Student Timetable (UTM Branded) loaded");

    const contentEl = document.getElementById("timetableContent");
    const sessionSelect = document.getElementById("sessionSelect");
    const semesterSelect = document.getElementById("semesterSelect");

    document.getElementById("loadTimetableBtn").addEventListener("click", loadTimetable);

    // Helper to sort sessions (e.g., 2025/2026)
    function compareSessions(sesiA, sesiB) {
      const yearA = parseInt(sesiA.split('/')[0] || 0);
      const yearB = parseInt(sesiB.split('/')[0] || 0);
      return yearA - yearB;
    }

    // Initialize dropdowns and load latest session automatically
    (async function initFilters() {
      const userSession = localStorage.getItem("TTMSFC_userSession");
      if (!userSession) {
        contentEl.innerHTML = `<div class="empty-message">Session expired. Please log in again.</div>`;
        return;
      }

      let user, matricNo;
      try {
        user = JSON.parse(userSession);
        matricNo = user.login_name || user.login;
      } catch (e) {
        contentEl.innerHTML = `<div class="empty-message">Invalid session data.</div>`;
        return;
      }

      try {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${encodeURIComponent(matricNo)}`;
        const res = await fetch(url);
        const allData = await res.json();

        if (!Array.isArray(allData) || allData.length === 0) {
          contentEl.innerHTML = `<div class="empty-message">No enrolled subjects found.</div>`;
          return;
        }

        // Find the most recent session and semester
        let latest = allData[0];
        for (const item of allData) {
          if (compareSessions(item.sesi, latest.sesi) > 0) {
            latest = item;
          } else if (item.sesi === latest.sesi && (item.semester || 0) > (latest.semester || 0)) {
            latest = item;
          }
        }

        // Populate Session Dropdown
        const sessions = {};
        allData.forEach(item => {
          const sesi = item.sesi || "Unknown";
          const sem = item.semester || "N/A";
          if (!sessions[sesi]) sessions[sesi] = new Set();
          sessions[sesi].add(sem);
        });

        let opts = '<option value="">-- Select Session --</option>';
        Object.keys(sessions).sort().reverse().forEach(s => {
          opts += `<option value="${s}">${s}</option>`;
        });
        sessionSelect.innerHTML = opts;

        // Listener for dynamic semester updates
        sessionSelect.addEventListener("change", () => {
          const s = sessionSelect.value;
          semesterSelect.innerHTML = s
            ? Array.from(sessions[s]).sort().map(sem => `<option value="${sem}">Semester ${sem}</option>`).join('')
            : '<option>Select session first</option>';
        });

        // Set defaults to latest
        sessionSelect.value = latest.sesi;
        const sems = Array.from(sessions[latest.sesi]).sort();
        semesterSelect.innerHTML = sems.map(sem =>
          `<option value="${sem}" ${sem == latest.semester ? 'selected' : ''}>Semester ${sem}</option>`
        ).join('');

        // Initial Load
        setTimeout(() => {
          loadTimetableForSession(latest.sesi, latest.semester);
        }, 300);

      } catch (err) {
        contentEl.innerHTML = `<div class="empty-message">Failed to load academic sessions.</div>`;
      }
    })();

    function loadTimetable() {
      const sesi = sessionSelect.value;
      const sem = semesterSelect.value;
      if (!sesi || !sem) return;
      loadTimetableForSession(sesi, sem);
    }

    async function loadTimetableForSession(sesi, semester) {
      const userSession = localStorage.getItem("TTMSFC_userSession");
      if (!userSession) return;
      
      contentEl.innerHTML = `<div class="loading">Loading timetable for ${sesi} Sem ${semester}...</div>`;

      try {
        const user = JSON.parse(userSession);
        const matricNo = user.login_name || user.login;

        // 1. Get Subject Enrollment (for names and section)
        const resAll = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matricNo}`);
        const allEnrollments = await resAll.json();
        const currentEnrollments = allEnrollments.filter(item => item.sesi === sesi && item.semester == semester);

        // 2. Get Lecturer Details
        const resSubjek = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${sesi}&semester=${semester}`);
        const subjekData = await resSubjek.json();

        const lecturerMap = {};
        if (Array.isArray(subjekData)) {
          subjekData.forEach(subj => {
            if (Array.isArray(subj.seksyen_list)) {
              subj.seksyen_list.forEach(sec => {
                lecturerMap[`${subj.kod_subjek}-${sec.seksyen}`] = (sec.pensyarah || 'â€”').trim();
              });
            }
          });
        }

        // 3. Fetch specific schedule for each subject
        const timetablePromises = currentEnrollments.map(async (subj) => {
          const res = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${sesi}&semester=${semester}&kod_subjek=${subj.kod_subjek}&seksyen=${subj.seksyen}`);
          const data = await res.json();
          return (Array.isArray(data) ? data : []).map(entry => ({
            ...entry,
            kod_subjek: subj.kod_subjek,
            nama_subjek: subj.nama_subjek || 'Subject',
            lecturer_name: lecturerMap[`${subj.kod_subjek}-${subj.seksyen}`] || 'â€”'
          }));
        });

        const allEntries = (await Promise.all(timetablePromises)).flat();
        displayTimetable(allEntries, sesi, semester);

      } catch (err) {
        contentEl.innerHTML = `<div class="empty-message">Error fetching data: ${err.message}</div>`;
      }
    }

    function displayTimetable(data, sesi, semester) {
      const timeSlots = [2,3,4,5,6,7,8,9,10];
      const days = [2,3,4,5,6];
      const dayNames = { 2: "Monday", 3: "Tuesday", 4: "Wednesday", 5: "Thursday", 6: "Friday" };
      const timeLabels = { 2: "08:00", 3: "09:00", 4: "10:00", 5: "11:00", 6: "12:00", 7: "13:00", 8: "14:00", 9: "15:00", 10: "16:00" };
      const timeDuration = { 2: "08:00-09:00", 3: "09:00-10:00", 4: "10:00-11:00", 5: "11:00-12:00", 6: "12:00-13:00", 7: "13:00-14:00", 8: "14:00-15:00", 9: "15:00-16:00", 10: "16:00-17:00" };

      const grid = {};
      const dailyHours = { 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      
      days.forEach(day => {
        grid[day] = {};
        timeSlots.forEach(time => { grid[day][time] = []; });
      });

      // Fill grid and count daily hours
      data.forEach(entry => {
        if (grid[entry.hari] && grid[entry.hari][entry.masa]) {
          grid[entry.hari][entry.masa].push(entry);
          dailyHours[entry.hari]++;
        }
      });

      let totalSessionsCount = 0;
      const totalWeeklyHours = data.length;

      // --- Build Desktop HTML ---
      let desktopHTML = `<div class="desktop-timetable"><div class="desktop-grid"><div class="corner-cell"></div>`;
      timeSlots.forEach(t => desktopHTML += `<div class="time-label">${timeLabels[t]}</div>`);
      
      days.forEach(day => {
        desktopHTML += `
          <div class="day-label">
            ${dayNames[day]}
            <span class="day-hours-subtext">${dailyHours[day]} hrs</span>
          </div>`;

        for (let i = 0; i < timeSlots.length; i++) {
          const classes = grid[day][timeSlots[i]];
          if (classes.length > 0) {
            totalSessionsCount++; // Increment count for a new continuous block
            const current = classes[0];
            let span = 1;
            
            // Check for continuous hours of same subject to span columns
            while (i + span < timeSlots.length && grid[day][timeSlots[i + span]].length > 0 && grid[day][timeSlots[i + span]][0].kod_subjek === current.kod_subjek) { 
              span++; 
            }

            desktopHTML += `
              <div class="grid-cell" style="--span: ${span}">
                <div class="class-item">
                  <div class="class-code">${current.kod_subjek}</div>
                  <div class="class-name">${current.nama_subjek}</div>
                  <div class="class-room">${current.ruang?.nama_ruang_singkatan || 'â€”'}</div>
                  <div class="class-lecturer">${current.lecturer_name}</div>
                </div>
              </div>`;
            i += (span - 1); 
          } else {
            desktopHTML += `<div class="grid-cell empty"><div class="empty-cell"></div></div>`;
          }
        }
      });
      desktopHTML += `</div></div>`;

      // --- Build Mobile HTML ---
      let mobileHTML = `<div class="mobile-timetable">`;
      days.forEach(day => {
        // Count sessions for mobile header
        let daySessions = 0;
        for (let j = 0; j < timeSlots.length; j++) {
            if (grid[day][timeSlots[j]].length > 0) {
                daySessions++;
                const code = grid[day][timeSlots[j]][0].kod_subjek;
                while(j+1 < timeSlots.length && grid[day][timeSlots[j+1]].length > 0 && grid[day][timeSlots[j+1]][0].kod_subjek === code) { j++; }
            }
        }

        mobileHTML += `
          <div class="day-card">
            <div class="day-header">
              <span>${dayNames[day]}</span>
              <span class="day-class-count">${daySessions} session${daySessions !== 1 ? 's' : ''}</span>
            </div>
            <div class="day-content">`;

        let hasClasses = false;
        timeSlots.forEach(time => {
          grid[day][time].forEach(cls => {
            hasClasses = true;
            mobileHTML += `
              <div class="time-slot-mobile">
                <div class="time-info">
                  <div class="time-period">${timeLabels[time]}</div>
                  <div class="time-duration">${timeDuration[time]}</div>
                </div>
                <div class="class-info">
                  <div class="class-item-mobile">
                    <div class="class-code-mobile">${cls.kod_subjek}</div>
                    <div class="class-name">${cls.nama_subjek}</div>
                    <div class="class-room-mobile">Room: ${cls.ruang?.kod_ruang || 'â€”'}</div>
                    <div class="class-lecturer-mobile">${cls.lecturer_name}</div>
                  </div>
                </div>
              </div>`;
          });
        });

        if (!hasClasses) mobileHTML += `<div class="empty-slot-mobile">No classes scheduled</div>`;
        mobileHTML += `</div></div>`;
      });
      mobileHTML += `</div>`;

      // --- Combine and Render ---
      contentEl.innerHTML = desktopHTML + mobileHTML + 
        `<div class="summary">Total Sessions: ${totalSessionsCount} â€¢ Total Weekly Hours: ${totalWeeklyHours} â€¢ ${sesi} Semester ${semester}</div>`;
    }
  })();
</script>
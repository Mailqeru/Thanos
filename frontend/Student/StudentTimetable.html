<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="refresh" content="900">
  <title>TTMS - My Timetable</title>
  <style>
    :root {
      --utm-blue: #003366;
      --utm-blue-dark: #002244;
      --utm-gold: #C9A85C;
      --utm-gold-light: #e6c98a;
      --light-bg: #f8f9fc;
      --input-border: #d1d5db;
      --error-red: #d32f2f;
      --sidebar-width: 240px;
      --header-height: 70px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light-bg);
      color: #333;
      overflow-x: hidden;
    }

    /* Sidebar */
    .sidebar {
      position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh;
      background: linear-gradient(180deg, var(--utm-blue) 0%, var(--utm-blue-dark) 100%);
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.15); z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto;
    }
    .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.15); }
    .sidebar-title { color: white; font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .sidebar-subtitle { color: rgba(255, 255, 255, 0.85); font-size: 13px; }
    .sidebar-user { padding: 20px 20px 10px; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .user-avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, var(--utm-gold) 0%, #8B6F3E 100%);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: white; margin-bottom: 10px; font-size: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .user-name { color: white; font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .user-role { color: rgba(255, 255, 255, 0.85); font-size: 12px; }
    .nav-item {
      display: flex; align-items: center; padding: 14px 20px;
      color: rgba(255, 255, 255, 0.9); text-decoration: none;
      transition: all 0.3s ease; border-left: 4px solid transparent;
      font-size: 15px; font-weight: 500;
    }
    .nav-item:hover { background: rgba(255, 255, 255, 0.15); border-left-color: var(--utm-gold); color: white; }
    .nav-item.active { background: rgba(255, 255, 255, 0.25); border-left-color: var(--utm-gold); color: white; font-weight: 600; }
    .nav-icon { margin-right: 12px; font-size: 18px; width: 24px; text-align: center; }
    .nav-logout { margin-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.15); padding-top: 20px; }

    /* Main Content */
    .main-wrapper { margin-left: var(--sidebar-width); min-height: 100vh; transition: margin-left 0.3s ease; }
    .top-header {
      position: sticky; top: 0; height: var(--header-height); background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); display: flex; align-items: center;
      padding: 0 25px; z-index: 100;
    }
    .menu-toggle {
      display: none; background: none; border: none; font-size: 24px; color: var(--utm-blue);
      cursor: pointer; padding: 8px; margin-right: 15px; border-radius: 8px; transition: background 0.2s;
    }
    .menu-toggle:hover { background: #f0f4ff; }
    .header-title { font-size: 22px; font-weight: 600; color: var(--utm-blue); }
    .header-actions { margin-left: auto; display: flex; align-items: center; gap: 15px; }
    .header-time {
      font-size: 14px; color: #555; padding: 8px 16px; background: #f0f4ff;
      border-radius: 8px; border: 1px solid #dde4f0;
    }
    .main-content { padding: 30px; max-width: 1400px; }

    /* Alerts */
    .alert { padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 12px; }
    .alert-info { background: #eef5ff; color: var(--utm-blue); border-left: 4px solid var(--utm-blue); }
    .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999; }
    .overlay.active { display: block; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main-wrapper { margin-left: 0; }
      .menu-toggle { display: block; }
      .main-content { padding: 20px 16px; }
      .top-header { padding: 0 16px; }
      .header-time { display: none; }
    }

    /* ===== TIMETABLE STYLES (VERTICAL LAYOUT) ===== */
    .timetable-container { max-width: 1200px; margin: 0 auto; }
    .timetable-container h3 { color: #003366; margin-bottom: 20px; font-weight: 600; font-size: 24px; text-align: center; }

    /* GRID SETUP: 1 Time Column + 5 Day Columns */
    .desktop-grid {
      background: white; border-radius: 12px; overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #eaeef5;
      margin-bottom: 20px; display: grid;
      /* INCREASED first column width to fit "08:00 - 09:00" */
      grid-template-columns: 120px repeat(5, 1fr); 
    }

    /* HEADERS (Top Row - Days) */
    .corner-cell { background: #003366; border-right: 1px solid rgba(255,255,255,0.2); }
    .day-header-cell {
      background: #003366; color: white; font-weight: 700; font-size: 14px;
      text-transform: uppercase; display: flex; align-items: center; justify-content: center;
      padding: 15px 5px; border-right: 1px solid rgba(255,255,255,0.2);
    }

    /* SIDEBAR (Left Column - Time) */
    .time-sidebar-cell {
      background: #f8f9fa; color: #003366; font-weight: 700; font-size: 11px; /* Smaller font for range */
      display: flex; align-items: center; justify-content: center;
      border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0;
      padding: 10px; min-height: 80px; text-align: center; white-space: nowrap;
    }

    /* CLASS CELLS */
    .grid-cell { border-right: 1px solid #eee; border-bottom: 1px solid #eee; display: flex; flex-direction: column; }
    .grid-cell.empty { background: #fff; }
    .class-item {
      background: #eef5ff; border-left: 5px solid #003366; padding: 8px;
      height: 100%; width: 100%; display: flex; flex-direction: column;
      justify-content: center; text-align: center;
    }
    .class-code { font-weight: 700; color: #003366; font-size: 12px; margin-bottom: 2px; }
    .class-name { font-size: 11px; color: #555; margin-bottom: 2px; line-height: 1.2; }
    .class-room, .class-lecturer { color: #666; font-size: 10px; font-style: italic; }

    /* SUMMARY BAR */
    .summary-bar {
      background: #eef5ff; border-left: 6px solid #003366;
      padding: 15px 20px; border-radius: 8px;
      display: flex; align-items: center; gap: 15px;
      color: #003366; font-size: 14px;
    }
    .summary-bar strong { font-weight: 700; font-size: 15px; }

    /* Hide Mobile Stuff */
    .mobile-timetable { display: none !important; }
    
    @media (max-width: 768px) {
      .desktop-grid { display: none; }
      .timetable-container { padding: 10px; }
      /* Fallback message for mobile if needed, or implement mobile view */
    }
  </style>
</head>
<body>

  <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">TTMS</div>
      <div class="sidebar-subtitle">Student Portal</div>
    </div>
    <div class="sidebar-user">
      <div class="user-avatar" id="userAvatar">S</div>
      <div class="user-name" id="userName">Loading...</div>
      <div class="user-role">Student</div>
    </div>
    <a class="nav-item" href="Main.html"><span class="nav-icon">ðŸ“Š</span><span>Dashboard</span></a>
    <a class="nav-item active" href="StudentTimetable.html"><span class="nav-icon">ðŸ“…</span><span>My Timetable</span></a>
    <a class="nav-item" href="StudentSubjects.html"><span class="nav-icon">ðŸ“š</span><span>My Subjects</span></a>
    <a class="nav-item" href="SubjectSection.html"><span class="nav-icon">ðŸ‘¥</span><span>Subject Sections</span></a>
    <div class="nav-logout">
      <a class="nav-item" id="navLogout"><span class="nav-icon">ðŸšª</span><span>Logout</span></a>
    </div>
  </nav>

  <div class="main-wrapper">
    <header class="top-header">
      <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
      <h1 class="header-title">My Timetable</h1>
      <div class="header-actions">
        <div class="header-time" id="currentTime">--:--</div>
      </div>
    </header>

    <main class="main-content">
      <div class="timetable-container">
        <h3 id="scheduleTitle">My Class Schedule</h3>
        <div id="timetableContent">
          <div class="loading">Detecting current session...</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Time & Sidebar Utils
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    }
    updateTime(); setInterval(updateTime, 60000);

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('active'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); }

    // Auth Check
    const session = localStorage.getItem("TTMSFC_userSession");
    if (!session) { alert("Please log in first."); window.location.replace("../index.html"); }
    let user;
    try {
      user = JSON.parse(session);
      document.getElementById("userName").textContent = user.full_name || user.login || "Student";
      document.getElementById("userAvatar").textContent = (user.full_name || "S")[0].toUpperCase();
    } catch(e) { localStorage.removeItem("TTMSFC_userSession"); window.location.replace("../index.html"); }

    document.getElementById("navLogout").onclick = function() {
      if(confirm("Logout?")) { localStorage.removeItem("TTMSFC_userSession"); window.location.replace("../index.html"); }
    };

    // --- TIMETABLE LOGIC ---
    
    // 1. Calculate Session & Semester based on Date
    function getCurrentAcademicPeriod() {
      const now = new Date();
      const month = now.getMonth() + 1; // 1-12
      const year = now.getFullYear();
      
      let session = "";
      let semester = "";

      // Rules:
      // Oct(10) - Feb(2) = Sem 1
      // Mar(3) - Jul(7) = Sem 2
      // Aug(8) - Sep(9) = Assuming transition/Sem 1 next
      
      if (month >= 10 || month <= 2) {
        // Semester 1
        semester = "1";
        // If Oct-Dec, Session is Current/Next. If Jan-Feb, Session is Prev/Current.
        if (month >= 10) {
           session = `${year}/${year + 1}`;
        } else {
           session = `${year - 1}/${year}`;
        }
      } else {
        // Semester 2 (Mar - Sep for safety)
        semester = "2";
        // Session corresponds to the academic year starting previous year
        session = `${year - 1}/${year}`;
      }

      return { session, semester };
    }

    // 2. Load Timetable Automatically
    const contentEl = document.getElementById("timetableContent");
    const { session: autoSession, semester: autoSemester } = getCurrentAcademicPeriod();

    document.getElementById("scheduleTitle").innerHTML = `My Class Schedule <span style="font-size:0.7em; color:#666; font-weight:normal;">(${autoSession} Sem ${autoSemester})</span>`;

    loadTimetableForSession(autoSession, autoSemester);

    async function loadTimetableForSession(sesi, semester) {
      const matricNo = user.login || user.login_name;
      contentEl.innerHTML = `<div class="loading">Loading timetable...</div>`;

      try {
        // Fetch Enrollments
        const resAll = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matricNo}`);
        const allEnrollments = await resAll.json();
        const currentEnrollments = allEnrollments.filter(item => item.sesi === sesi && item.semester == semester);

        // Fetch Lecturer Info
        const resSubjek = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${sesi}&semester=${semester}`);
        const subjekData = await resSubjek.json();
        const lecturerMap = {};
        if (Array.isArray(subjekData)) {
          subjekData.forEach(subj => {
             if (subj.seksyen_list) subj.seksyen_list.forEach(sec => lecturerMap[`${subj.kod_subjek}-${sec.seksyen}`] = sec.pensyarah);
          });
        }

        // Fetch Schedule
        const promises = currentEnrollments.map(async (subj) => {
          const res = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${sesi}&semester=${semester}&kod_subjek=${subj.kod_subjek}&seksyen=${subj.seksyen}`);
          const data = await res.json();
          return (Array.isArray(data) ? data : []).map(entry => ({
            ...entry, kod_subjek: subj.kod_subjek, nama_subjek: subj.nama_subjek, lecturer_name: lecturerMap[`${subj.kod_subjek}-${subj.seksyen}`] || 'â€”'
          }));
        });

        const allEntries = (await Promise.all(promises)).flat();
        displayTimetable(allEntries, sesi, semester);

      } catch (err) {
        contentEl.innerHTML = `<div class="empty-message">Error loading timetable. Please check connection.</div>`;
      }
    }

    function displayTimetable(data, sesi, semester) {
      // Extended Time Slots: 08:00 (2) to 22:00 (15)
      // Mapping: 2=8am, 3=9am ... 14=8pm, 15=9pm-10pm
      const timeSlots = [];
      for(let i=2; i<=15; i++) timeSlots.push(i);

      const days = [2,3,4,5,6]; // Mon - Fri
      const dayNames = { 2: "MONDAY", 3: "TUESDAY", 4: "WEDNESDAY", 5: "THURSDAY", 6: "FRIDAY" };

      // Helper to generate "08:00 - 09:00" string
      const getTimeLabel = (slot) => {
         const startH = slot + 6; // 2+6 = 8
         const endH = startH + 1;
         const fmt = (h) => h < 10 ? `0${h}:00` : `${h}:00`;
         return `${fmt(startH)} - ${fmt(endH)}`;
      };

      // Organize Data
      const grid = {};
      const occupied = {}; 
      
      days.forEach(day => {
        grid[day] = {};
        occupied[day] = {}; 
        timeSlots.forEach(time => { 
            grid[day][time] = []; 
            occupied[day][time] = false;
        });
      });

      data.forEach(entry => {
        if (grid[entry.hari] && grid[entry.hari][entry.masa]) {
          grid[entry.hari][entry.masa].push(entry);
        }
      });

      let totalSessionsCount = 0;
      const totalWeeklyHours = data.length;

      // --- HTML GENERATION ---
      let html = `<div class="desktop-timetable"><div class="desktop-grid">`;
      
      // Header Row
      html += `<div class="corner-cell"></div>`;
      days.forEach(day => { html += `<div class="day-header-cell">${dayNames[day]}</div>`; });

      // Body Rows
      for (let i = 0; i < timeSlots.length; i++) {
          const t = timeSlots[i];
          
          // Time Label with Range
          html += `<div class="time-sidebar-cell">${getTimeLabel(t)}</div>`;

          // Day Columns
          for (let d = 0; d < days.length; d++) {
              const day = days[d];
              
              if (occupied[day][t]) continue;

              const classes = grid[day][t];
              
              if (classes.length > 0) {
                  totalSessionsCount++;
                  const current = classes[0];
                  
                  // Calculate Span
                  let span = 1;
                  while (i + span < timeSlots.length && 
                         grid[day][timeSlots[i + span]].length > 0 && 
                         grid[day][timeSlots[i + span]][0].kod_subjek === current.kod_subjek) {
                      span++;
                  }

                  // Mark Occupied
                  for (let k = 1; k < span; k++) occupied[day][timeSlots[i + k]] = true;

                  html += `
                    <div class="grid-cell" style="grid-row: span ${span}">
                      <div class="class-item">
                        <div class="class-code">${current.kod_subjek}</div>
                        <div class="class-name">${current.nama_subjek}</div>
                        
                        <div class="class-room" style="font-weight: 900; color: #000; font-size: 11px; margin: 4px 0;">
                          ${current.ruang?.nama_ruang || current.ruang?.kod_ruang || 'â€”'}
                        </div>

                        <div class="class-lecturer">${current.lecturer_name}</div>
                      </div>
                    </div>`;
              } else {
                  html += `<div class="grid-cell empty"></div>`;
              }
          }
      }
      html += `</div></div>`;

      const summaryHTML = `
        <div class="summary-bar">
          <div>Total Sessions: <strong>${totalSessionsCount}</strong></div>
          <div>â€¢</div>
          <div>Total Weekly Hours: <strong>${totalWeeklyHours}</strong></div>
          <div>â€¢</div>
          <div><strong>${sesi} Semester ${semester}</strong></div>
        </div>
      `;

      contentEl.innerHTML = html + summaryHTML;
    }
  </script>
</body>
</html>
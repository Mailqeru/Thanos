<div class="timetable-container">
  <h3>My Class Schedule</h3>

  <div class="filters">
    <div class="filter-group">
      <label for="sessionSelect">Session</label>
      <select id="sessionSelect">
        <option value="">Loading...</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="semesterSelect">Semester</label>
      <select id="semesterSelect">
        <option value="">Select session first</option>
      </select>
    </div>

    <div class="filter-group">
      <label>&nbsp;</label>
      <button id="loadTimetableBtn">Load Timetable</button>
    </div>
  </div>

  <div id="timetableContent">
    <div class="loading">Loading your enrolled sessions...</div>
  </div>
</div>

<style>
  .timetable-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 16px;
  }

  .timetable-container h3 {
    color: #003366; /* UTM blue */
    margin-bottom: 24px;
    font-weight: 600;
    font-size: 24px;
    text-align: center;
  }

  .filters {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #444;
    font-size: 14px;
  }

  .filter-group select,
  .filter-group button {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    background: white;
    color: #333;
    transition: all 0.3s ease;
  }

  .filter-group select {
    appearance: none;
    background-image: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23003366' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }

  .filter-group button {
    background: linear-gradient(135deg, #003366 0%, #002244 100%); /* UTM blue gradient */
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 6px rgba(0, 51, 102, 0.3);
  }

  .filter-group button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 51, 102, 0.4);
  }

  /* ===== DESKTOP TIMETABLE GRID ===== */
  .desktop-timetable {
    display: block;
  }

  .desktop-grid {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid #eaeef5;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: 100px repeat(9, 1fr);
  }

  .day-label {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border-right: 1px solid rgba(255,255,255,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }

  .time-label {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
    padding: 12px 8px;
    border-right: 1px solid rgba(255,255,255,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }

  .corner-cell {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    border-right: 1px solid rgba(255,255,255,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }

.class-item {
  background: #eef5ff;
  border-left: 5px solid #003366; /* Thicker bar for better structure */
  padding: 8px;
  font-size: 12px;
  height: 100%;           /* IMPORTANT: This makes it a "long bar" */
  width: 100%;            /* Ensure it fills width */
  box-sizing: border-box; 
  display: flex;
  flex-direction: column;
  justify-content: center; /* Centers content vertically */
  align-items: center;     /* Centers content horizontally */
  text-align: center;
}
.grid-cell {
  grid-column: span var(--span, 1);
  padding: 0 !important; /* Removes gaps to make the bar solid */
  min-height: 100px;
}
.grid-cell.empty {
    background: #fafbff;
  }

  /* ===== MOBILE TIMETABLE LIST ===== */
  .mobile-timetable {
    display: none;
  }

  .day-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 16px;
    overflow: hidden;
    border: 1px solid #eaeef5;
  }

  .day-header {
    background: linear-gradient(135deg, #003366 0%, #002244 100%);
    color: white;
    padding: 14px 16px;
    font-weight: 700;
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .day-content {
    padding: 0;
  }

  .time-slot-mobile {
    padding: 16px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .time-slot-mobile:last-child {
    border-bottom: none;
  }

  .time-info {
    min-width: 80px;
    flex-shrink: 0;
  }

  .time-period {
    font-weight: 700;
    color: #003366; /* UTM blue */
    font-size: 14px;
    margin-bottom: 2px;
  }

  .time-duration {
    font-size: 12px;
    color: #666;
  }

  .class-info {
    flex: 1;
  }

  .class-item-mobile {
    background: #eef5ff;
    border-left: 4px solid #003366; /* UTM blue */
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .class-code-mobile {
    font-weight: 700;
    color: #003366; /* UTM blue */
    font-size: 14px;
    margin-bottom: 4px;
  }

  .class-room-mobile,
  .class-lecturer-mobile {
    color: #555;
    font-size: 12px;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
    color: #003366;
  }

  .empty-slot-mobile {
    text-align: center;
    padding: 16px;
    color: #999;
    font-style: italic;
    font-size: 14px;
  }

  /* Class items (desktop) */
  .class-item {
    background: #eef5ff;
    border-left: 4px solid #003366; /* UTM blue */
    padding: 8px;
    border-radius: 6px;
    font-size: 12px;
    margin-bottom: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .class-code {
    font-weight: 700;
    color: #003366; /* UTM blue */
    font-size: 13px;
    margin-bottom: 2px;
  }

  .class-room,
  .class-lecturer {
    color: #555;
    font-size: 11px;
  }

  .empty-cell::before {
    content: "â€”";
    color: #ccc;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }

  /* Summary */
  .summary {
    margin-top: 20px;
    padding: 14px 20px;
    background-color: #f0f5ff;
    border-left: 4px solid #003366; /* UTM blue */
    font-weight: 600;
    color: #003366; /* UTM blue */
    border-radius: 0 8px 8px 0;
    font-size: 14px;
  }

  .empty-message, .loading {
    text-align: center;
    padding: 30px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    color: #666;
    border: 1px solid #eee;
  }

  .loading {
    color: #003366; /* UTM blue */
    font-style: italic;
  }

  /* ===== RESPONSIVE BREAKPOINTS ===== */
  @media (max-width: 1024px) {
    .desktop-grid {
      grid-template-columns: 80px repeat(9, 1fr);
    }
    
    .day-label, .time-label {
      font-size: 12px;
      padding: 10px 6px;
    }
    
    .grid-cell {
      min-height: 80px;
      padding: 6px;
    }
    
    .class-item {
      padding: 6px;
      font-size: 11px;
    }
    
    .class-code {
      font-size: 12px;
    }
  }

  @media (max-width: 768px) {
    .timetable-container {
      padding: 0 12px;
    }
    
    .timetable-container h3 {
      font-size: 20px;
      margin-bottom: 20px;
    }
    
    .filters {
      flex-direction: column;
      gap: 12px;
    }

    .filter-group {
      min-width: 100%;
    }
    
    .filter-group label {
      font-size: 13px;
    }
    
    .filter-group select,
    .filter-group button {
      padding: 10px 14px;
      font-size: 15px;
    }

    .desktop-timetable {
      display: none;
    }
    
    .mobile-timetable {
      display: block;
    }
    
    .day-header {
      padding: 12px 14px;
      font-size: 15px;
    }
    
    .time-slot-mobile {
      padding: 14px;
      flex-direction: column;
      gap: 8px;
    }
    
    .time-info {
      min-width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 8px;
      border-bottom: 1px dashed #eee;
    }
    
    .class-item-mobile {
      padding: 10px;
      width: 100%;
    }
    
    .class-code-mobile {
      font-size: 13px;
    }
    
    .class-room-mobile,
    .class-lecturer-mobile {
      font-size: 11px;
    }
    
    .summary {
      font-size: 13px;
      padding: 12px 16px;
      margin-top: 16px;
    }
  }

  @media (max-width: 480px) {
    .timetable-container {
      padding: 0 8px;
    }
    
    .timetable-container h3 {
      font-size: 18px;
    }
    
    .filter-group select,
    .filter-group button {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    .day-header {
      padding: 10px 12px;
      font-size: 14px;
    }
    
    .time-slot-mobile {
      padding: 12px;
    }
    
    .time-period {
      font-size: 13px;
    }
    
    .time-duration {
      font-size: 11px;
    }
    
    .class-item-mobile {
      padding: 8px;
    }
    
    .class-code-mobile {
      font-size: 12px;
    }
    
    .class-room-mobile,
    .class-lecturer-mobile {
      font-size: 10px;
    }
    
    .empty-slot-mobile {
      padding: 12px;
      font-size: 12px;
    }
    
    .icon {
      width: 12px;
      height: 12px;
    }
  }

  @media (max-width: 360px) {
    .timetable-container h3 {
      font-size: 16px;
    }
    
    .day-header {
      flex-direction: column;
      gap: 4px;
      text-align: center;
    }
    
    .time-info {
      flex-direction: column;
      text-align: center;
      gap: 2px;
    }
    
    .time-period {
      font-size: 12px;
    }
    
    .class-item-mobile {
      padding: 6px;
    }
    
    .summary {
      font-size: 12px;
      padding: 10px 12px;
    }
  }
</style>

<script>
  (function() {
    console.log("ðŸ“… Student Timetable (UTM Branded) loaded");

    const contentEl = document.getElementById("timetableContent");
    const sessionSelect = document.getElementById("sessionSelect");
    const semesterSelect = document.getElementById("semesterSelect");

    document.getElementById("loadTimetableBtn").addEventListener("click", loadTimetable);

    function compareSessions(sesiA, sesiB) {
      const yearA = parseInt(sesiA.split('/')[0] || 0);
      const yearB = parseInt(sesiB.split('/')[0] || 0);
      return yearA - yearB;
    }

    (async function initFilters() {
      const userSession = localStorage.getItem("TTMSFC_userSession");
      if (!userSession) {
        contentEl.innerHTML = `<div class="empty-message">Session expired.</div>`;
        return;
      }

      let user, matricNo;
      try {
        user = JSON.parse(userSession);
        matricNo = user.login_name || user.login;
      } catch (e) {
        contentEl.innerHTML = `<div class="empty-message">Invalid session.</div>`;
        return;
      }

      if (!matricNo) {
        contentEl.innerHTML = `<div class="empty-message">Matric number missing.</div>`;
        return;
      }

      try {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${encodeURIComponent(matricNo)}`;
        const res = await fetch(url);
        const allData = await res.json();

        if (!Array.isArray(allData) || allData.length === 0) {
          contentEl.innerHTML = `<div class="empty-message">No enrolled subjects found.</div>`;
          return;
        }

        let latest = allData[0];
        for (const item of allData) {
          if (compareSessions(item.sesi, latest.sesi) > 0) {
            latest = item;
          } else if (item.sesi === latest.sesi && (item.semester || 0) > (latest.semester || 0)) {
            latest = item;
          }
        }

        const sessions = {};
        allData.forEach(item => {
          const sesi = item.sesi || "Unknown";
          const sem = item.semester || "N/A";
          if (!sessions[sesi]) sessions[sesi] = new Set();
          sessions[sesi].add(sem);
        });

        let opts = '<option value="">-- Select Session --</option>';
        Object.keys(sessions).sort().reverse().forEach(s => {
          opts += `<option value="${s}">${s}</option>`;
        });
        sessionSelect.innerHTML = opts;

        sessionSelect.addEventListener("change", () => {
          const s = sessionSelect.value;
          semesterSelect.innerHTML = s
            ? Array.from(sessions[s]).sort().map(sem => `<option value="${sem}">Semester ${sem}</option>`).join('')
            : '<option>Select session first</option>';
        });

        sessionSelect.value = latest.sesi;
        const sems = Array.from(sessions[latest.sesi]).sort();
        semesterSelect.innerHTML = sems.map(sem =>
          `<option value="${sem}" ${sem == latest.semester ? 'selected' : ''}>Semester ${sem}</option>`
        ).join('');

        setTimeout(() => {
          const sesi = latest.sesi;
          const sem = latest.semester;
          loadTimetableForSession(sesi, sem);
        }, 300);

      } catch (err) {
        contentEl.innerHTML = `<div class="empty-message">Failed to load sessions.</div>`;
      }
    })();

    function loadTimetable() {
      const sesi = sessionSelect.value;
      const sem = semesterSelect.value;
      if (!sesi || !sem) {
        contentEl.innerHTML = `<div class="empty-message">Please select session and semester.</div>`;
        return;
      }
      loadTimetableForSession(sesi, sem);
    }

    async function loadTimetableForSession(sesi, semester) {
      const userSession = localStorage.getItem("TTMSFC_userSession");
      if (!userSession) {
        contentEl.innerHTML = `<div class="empty-message">Session expired.</div>`;
        return;
      }

      let user, matricNo;
      try {
        user = JSON.parse(userSession);
        matricNo = user.login_name || user.login;
      } catch (e) {
        contentEl.innerHTML = `<div class="empty-message">Invalid session.</div>`;
        return;
      }

      contentEl.innerHTML = `<div class="loading">Loading timetable for ${sesi} Semester ${semester}...</div>`;

      try {
        const urlPelajar = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matricNo}`;
        const resAll = await fetch(urlPelajar);
        const allEnrollments = await resAll.json();

        if (!Array.isArray(allEnrollments)) {
          throw new Error("Invalid enrollment data");
        }

        const currentEnrollments = allEnrollments.filter(item =>
          item.sesi === sesi && item.semester == semester
        );

        if (currentEnrollments.length === 0) {
          contentEl.innerHTML = `<div class="empty-message">No subjects found for ${sesi} Semester ${semester}.</div>`;
          return;
        }

        const urlSubjekSeksyen = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${sesi}&semester=${semester}`;
        const resSubjek = await fetch(urlSubjekSeksyen);
        const subjekData = await resSubjek.json();

        const lecturerMap = {};
        if (Array.isArray(subjekData)) {
          subjekData.forEach(subj => {
            if (Array.isArray(subj.seksyen_list)) {
              subj.seksyen_list.forEach(sec => {
                lecturerMap[`${subj.kod_subjek}-${sec.seksyen}`] = (sec.pensyarah || 'â€”').trim();
              });
            }
          });
        }

        const timetablePromises = currentEnrollments.map(async (subj) => {
          const urlJadual = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${sesi}&semester=${semester}&kod_subjek=${subj.kod_subjek}&seksyen=${subj.seksyen}`;
          const res = await fetch(urlJadual);
          const data = await res.json();
          return (Array.isArray(data) ? data : [])
            .filter(entry => entry.hari >= 2 && entry.hari <= 6 && entry.masa >= 2 && entry.masa <= 10)
            .map(entry => ({
              ...entry,
              kod_subjek: subj.kod_subjek,
              course_name: subj.nama_subjek || 'â€”',
              lecturer_name: lecturerMap[`${subj.kod_subjek}-${subj.seksyen}`] || 'â€”',
              seksyen: subj.seksyen
            }));
        });

        const timetableArrays = await Promise.all(timetablePromises);
        const allEntries = timetableArrays.flat();

        if (allEntries.length === 0) {
          contentEl.innerHTML = `<div class="empty-message">No class schedule found for ${sesi} Semester ${semester}.</div>`;
          return;
        }

        displayTimetable(allEntries, sesi, semester);

      } catch (err) {
        console.error("Timetable load error:", err);
        contentEl.innerHTML = `<div class="empty-message">Error: ${err.message || 'Failed to load timetable'}</div>`;
      }
    }

    function displayTimetable(data, sesi, semester) {
      const timeSlots = [2,3,4,5,6,7,8,9,10];
      const days = [2,3,4,5,6];
      
      const dayNames = { 2: "Monday", 3: "Tuesday", 4: "Wednesday", 5: "Thursday", 6: "Friday" };
      const timeLabels = { 2: "08:00", 3: "09:00", 4: "10:00", 5: "11:00", 6: "12:00", 7: "13:00", 8: "14:00", 9: "15:00", 10: "16:00" };
      const timeDuration = { 2: "08:00-09:00", 3: "09:00-10:00", 4: "10:00-11:00", 5: "11:00-12:00", 6: "12:00-13:00", 7: "13:00-14:00", 8: "14:00-15:00", 9: "15:00-16:00", 10: "16:00-17:00" };

      const grid = {};
      days.forEach(day => {
        grid[day] = {};
        timeSlots.forEach(time => {
          grid[day][time] = [];
        });
      });

      data.forEach(entry => {
        if (grid[entry.hari] && grid[entry.hari][entry.masa]) {
          grid[entry.hari][entry.masa].push(entry);
        }
      });

      // Desktop view
      let desktopHTML = `<div class="desktop-timetable"><div class="desktop-grid">`;
      desktopHTML += `<div class="corner-cell"></div>`;
      timeSlots.forEach(time => { desktopHTML += `<div class="time-label">${timeLabels[time]}</div>`; });
      days.forEach(day => {
        desktopHTML += `<div class="day-label">${dayNames[day]}</div>`;
        
        for (let i = 0; i < timeSlots.length; i++) {
          const time = timeSlots[i];
          const classes = grid[day][time];

          if (classes.length > 0) {
            const currentClass = classes[0];
            let span = 1;

            // BIG BAR Logic: Checks if next hours are the same subject
            while (
              i + span < timeSlots.length && 
              grid[day][timeSlots[i + span]].length > 0 &&
              grid[day][timeSlots[i + span]][0].kod_subjek === currentClass.kod_subjek
            ) {
              span++;
            }

            const roomName = currentClass.ruang?.nama_ruang_singkatan || 'â€”';
            
            desktopHTML += `
              <div class="grid-cell" style="--span: ${span}">
                <div class="class-item">
                  <div class="class-code">${currentClass.kod_subjek}</div>
                  <div class="class-room">${roomName}</div>
                  <div class="class-lecturer">${currentClass.lecturer_name}</div>
                </div>
              </div>`;
            
            i += (span - 1); // Skip slots already merged into the bar
          } else {
            desktopHTML += `<div class="grid-cell empty"><div class="empty-cell"></div></div>`;
          }
        }
      });
      desktopHTML += `</div></div>`;

      // Mobile view
      let mobileHTML = `<div class="mobile-timetable">`;
      days.forEach(day => {
        mobileHTML += `<div class="day-card">`;
        const classCount = timeSlots.reduce((sum, t) => sum + (grid[day][t]?.length || 0), 0);
        mobileHTML += `<div class="day-header"><span>${dayNames[day]}</span><span class="day-class-count">${classCount} class${classCount !== 1 ? 'es' : ''}</span></div>`;
        mobileHTML += `<div class="day-content">`;
        let hasClasses = false;
        timeSlots.forEach(time => {
          const classes = grid[day][time];
          if (classes.length > 0) {
            hasClasses = true;
            classes.forEach(cls => {
              const roomCode = cls.ruang?.kod_ruang || 'â€”';
              const roomName = cls.ruang?.nama_ruang_singkatan || 'â€”';
              mobileHTML += `
                <div class="time-slot-mobile">
                  <div class="time-info">
                    <div class="time-period">${timeLabels[time]}</div>
                    <div class="time-duration">${timeDuration[time]}</div>
                  </div>
                  <div class="class-info">
                    <div class="class-item-mobile">
                      <div class="class-code-mobile">${cls.kod_subjek}</div>
                      <div class="class-room-mobile">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                        ${roomCode} (${roomName})
                      </div>
                      <div class="class-lecturer-mobile">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        ${cls.lecturer_name}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });
          }
        });
        if (!hasClasses) {
          mobileHTML += `<div class="empty-slot-mobile">No classes scheduled</div>`;
        }
        mobileHTML += `</div></div>`;
      });
      mobileHTML += `</div>`;

      const totalHTML = desktopHTML + mobileHTML + `<div class="summary">Total Classes: ${data.length} â€¢ ${sesi} Semester ${semester}</div>`;
      contentEl.innerHTML = totalHTML;
    }
  })();
</script>

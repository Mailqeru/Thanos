<div class="subject-sections-container">
  <h3>Subject Sections â€“ With Class Schedule</h3>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="sessionSelect">Session</label>
      <select id="sessionSelect">
        <option value="">Loading...</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="semesterSelect">Semester</label>
      <select id="semesterSelect">
        <option value="">Select session first</option>
      </select>
    </div>
    <div class="filter-group">
      <label>&nbsp;</label>
      <button id="loadSectionsBtn">Load Valid Sections</button>
    </div>
  </div>

  <!-- Search -->
  <div id="searchContainer" class="search-container" style="display:none;">
    <input type="text" id="searchInput" placeholder="Search by course code or subject name..." />
    <div class="info-note">Only sections with lecturer & â‰¥1 enrolled student are shown.</div>
  </div>

  <!-- Content -->
  <div id="sectionsContent">
    <div class="loading">Loading enrolled sessions...</div>
  </div>
</div>

<style>
  .subject-sections-container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .subject-sections-container h3 {
    color: var(--primary);
    margin-bottom: 24px;
    font-weight: 600;
    font-size: 24px;
  }

  .filters {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #444;
  }

  .filter-group select,
  .filter-group button {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-color, #d1d5db);
    border-radius: 8px;
    font-size: 16px;
    background: white;
    color: #333;
  }

  .filter-group select {
    appearance: none;
    background-image: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }

  .filter-group button {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
  }

  .filter-group button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
  }

  .search-container {
    margin: 20px 0;
  }

  .search-container input {
    width: 100%;
    max-width: 600px;
    padding: 12px 16px;
    border: 1px solid var(--border-color, #d1d5db);
    border-radius: 8px;
    font-size: 16px;
  }

  .info-note {
    font-size: 0.85em;
    color: #666;
    margin-top: 6px;
  }

  .subject-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    margin-bottom: 24px;
    overflow: hidden;
    border: 1px solid #eaeef5;
  }

  .subject-card header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    padding: 14px 20px;
  }

  .subject-card header h5 {
    margin: 0;
    color: white;
    font-size: 18px;
    font-weight: 600;
  }

  .subject-card table {
    width: 100%;
    border-collapse: collapse;
  }

  .subject-card th,
  .subject-card td {
    padding: 14px 20px;
    text-align: left;
    border-bottom: 1px solid #f0f2f8;
  }

  .subject-card thead th {
    background-color: #f8f9ff;
    color: var(--primary);
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .subject-card tbody tr:hover {
    background-color: #fafbff;
  }

  .schedule-entry {
    line-height: 1.4;
    margin-bottom: 4px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 24px 0;
  }

  .pagination button {
    padding: 8px 16px;
    border: 1px solid var(--primary);
    background: white;
    color: var(--primary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
  }

  .pagination button:hover:not(:disabled) {
    background: var(--light);
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination .page-info {
    font-weight: 600;
    color: var(--primary);
  }

  .summary {
    margin-top: 20px;
    padding: 14px 20px;
    background-color: #f0f5ff;
    border-left: 4px solid var(--primary);
    font-weight: 600;
    color: var(--primary);
    border-radius: 0 8px 8px 0;
    font-size: 14px;
  }

  .empty-message, .loading {
    text-align: center;
    padding: 30px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    color: #666;
    border: 1px solid #eee;
  }

  .loading {
    color: var(--primary);
    font-style: italic;
  }

  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Mobile */
  @media (max-width: 600px) {
    .filters {
      flex-direction: column;
    }

    .filter-group {
      min-width: 100%;
    }

    .subject-sections-container {
      padding: 0 12px;
    }

    .subject-card th,
    .subject-card td {
      padding: 10px;
      font-size: 13px;
    }

    .filter-group select,
    .filter-group button {
      padding: 10px 14px;
      font-size: 14px;
      padding-right: 36px;
    }
  }
</style>

<script>
  (function() {
    console.log("ðŸ‘¥ Subject Sections fragment loaded");

    // Constants
    const hariMap = { 2: "Mon", 3: "Tue", 4: "Wed", 5: "Thu", 6: "Fri", 7: "Sat", 8: "Sun" };
    const masaMap = {
      2: "08:00â€“09:00", 3: "09:00â€“10:00", 4: "10:00â€“11:00", 5: "11:00â€“12:00",
      6: "12:00â€“13:00", 7: "13:00â€“14:00", 8: "14:00â€“15:00", 9: "15:00â€“16:00", 10: "16:00â€“17:00"
    };

    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let validSubjectList = [];
    let currentSesi = '';
    let currentSemester = '';
    let globalEnrichedData = [];
    let totalPages = 0;

    // Re-attach event listeners
    document.getElementById("loadSectionsBtn").addEventListener("click", loadSubjectSections);
    document.getElementById("searchInput").addEventListener("input", filterSections);

    // Initialize filters
    (async function initFilters() {
      const userSession = localStorage.getItem("TTMSFC_userSession");
      const contentEl = document.getElementById("sectionsContent");
      const sessionSelect = document.getElementById("sessionSelect");
      const semesterSelect = document.getElementById("semesterSelect");

      if (!userSession) {
        contentEl.innerHTML = `<div class="empty-message">Session expired. Please log in again.</div>`;
        return;
      }

      try {
        const user = JSON.parse(userSession);
        const matricNo = user.login_name || user.login;
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${encodeURIComponent(matricNo)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          sessionSelect.innerHTML = "<option>No sessions found</option>";
          contentEl.innerHTML = `<div class="empty-message">You are not enrolled in any subjects.</div>`;
          return;
        }

        const sessions = {};
        data.forEach(item => {
          const sesi = item.sesi || 'Unknown';
          const sem = item.semester || 'N/A';
          if (!sessions[sesi]) sessions[sesi] = new Set();
          sessions[sesi].add(sem);
        });

        let sessionOptions = '<option value="">-- Select Session --</option>';
        Object.keys(sessions).sort().reverse().forEach(s => {
          sessionOptions += `<option value="${s}">${s}</option>`;
        });
        sessionSelect.innerHTML = sessionOptions;

        sessionSelect.addEventListener('change', () => {
          const sesi = sessionSelect.value;
          semesterSelect.innerHTML = sesi
            ? Array.from(sessions[sesi]).sort().map(sem => `<option value="${sem}">Semester ${sem}</option>`).join('')
            : '<option>Select session first</option>';
        });

        const latestSesi = Object.keys(sessions).sort().reverse()[0];
        if (latestSesi) {
          sessionSelect.value = latestSesi;
          const latestSem = Array.from(sessions[latestSesi]).sort().reverse()[0];
          semesterSelect.innerHTML = Array.from(sessions[latestSesi]).sort().map(sem =>
            `<option value="${sem}" ${sem == latestSem ? 'selected' : ''}>Semester ${sem}</option>`
          ).join('');
        }

        contentEl.innerHTML = `<p class="empty-message">Select session & semester, then click <strong>Load Valid Sections</strong>.</p>`;
      } catch (err) {
        contentEl.innerHTML = `<div class="empty-message">Failed to load sessions.</div>`;
      }
    })();

    function isValidSection(sec) {
      const lecturer = (sec.pensyarah || '').toString().trim().toLowerCase();
      const hasLecturer = lecturer !== '' && lecturer !== 'tba';
      const hasEnrolled = (sec.bil_pelajar || 0) > 0;
      return hasLecturer && hasEnrolled;
    }

    async function loadSubjectSections() {
      const userSession = localStorage.getItem("TTMSFC_userSession");
      if (!userSession) {
        document.getElementById("sectionsContent").innerHTML = `<div class="empty-message">Session expired.</div>`;
        document.getElementById("searchContainer").style.display = "none";
        return;
      }

      currentSesi = document.getElementById("sessionSelect").value;
      currentSemester = document.getElementById("semesterSelect").value;
      if (!currentSesi || !currentSemester) {
        alert("Please select both session and semester.");
        return;
      }

      currentPage = 1;
      document.getElementById("sectionsContent").innerHTML = "<div class='loading'>Loading and filtering subjects...</div>";
      document.getElementById("searchContainer").style.display = "none";

      try {
        const urlSections = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}`;
        const resSec = await fetch(urlSections);
        const allSubjects = await resSec.json();

        if (!Array.isArray(allSubjects) || allSubjects.length === 0) {
          throw new Error("No subjects offered.");
        }

        const cleanedSubjects = allSubjects
          .filter(subj => subj.seksyen_list && Array.isArray(subj.seksyen_list))
          .map(subj => {
            const validSections = subj.seksyen_list.filter(isValidSection);
            return validSections.length > 0 ? { ...subj, seksyen_list: validSections } : null;
          })
          .filter(Boolean);

        if (cleanedSubjects.length === 0) {
          throw new Error("No valid sections found.");
        }

        validSubjectList = cleanedSubjects;
        totalPages = Math.ceil(validSubjectList.length / ITEMS_PER_PAGE);
        await loadPage(currentPage);
        document.getElementById("searchContainer").style.display = "block";
      } catch (err) {
        document.getElementById("sectionsContent").innerHTML = 
          `<div class="empty-message">Error: ${err.message || 'Failed to load sections'}</div>`;
      }
    }

    async function loadPage(page) {
      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const pageSubjects = validSubjectList.slice(startIndex, startIndex + ITEMS_PER_PAGE);

      document.getElementById("sectionsContent").innerHTML = `<div class='loading'>Loading schedules for page ${page} of ${totalPages}...</div>`;

      const fetchPromises = [];

      pageSubjects.forEach(subj => {
        const kod = (subj.kod_subjek || '').trim();
        const nama = (subj.nama_subjek || '').trim();

        (subj.seksyen_list || []).forEach(sec => {
          const seksyen = (sec.seksyen || '').trim();
          const lecturer = (sec.pensyarah || '').trim();
          const enrolled = sec.bil_pelajar || 0;
          const searchable = [kod, nama, lecturer].filter(x => x).join(' ').toLowerCase();

          const promise = (async () => {
            try {
              const urlJadual = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}&kod_subjek=${encodeURIComponent(kod)}&seksyen=${encodeURIComponent(seksyen)}`;
              const res = await fetch(urlJadual);
              const jadualList = await res.json();

              const scheduleEntries = (Array.isArray(jadualList) ? jadualList : [])
                .filter(e => e.hari && e.masa)
                .map(e => ({
                  day: hariMap[e.hari] || `Day ${e.hari}`,
                  time: masaMap[e.masa] || `Slot ${e.masa}`,
                  room: (e.ruang?.kod_ruang) || 'â€”'
                }));

              return { kod, nama, seksyen, lecturer, enrolled, scheduleEntries, searchable };
            } catch (err) {
              return { kod, nama, seksyen, lecturer, enrolled, scheduleEntries: [], searchable };
            }
          })();

          fetchPromises.push(promise);
        });
      });

      try {
        globalEnrichedData = await Promise.all(fetchPromises);

        const grouped = {};
        globalEnrichedData.forEach(item => {
          const key = item.kod || 'UNKNOWN';
          if (!grouped[key]) {
            grouped[key] = { kod: item.kod, nama: item.nama, sections: [] };
          }
          grouped[key].sections.push(item);
        });

        renderSections(Object.values(grouped), currentSesi, currentSemester, page);
      } catch (err) {
        document.getElementById("sectionsContent").innerHTML = 
          `<div class="empty-message">Error loading schedules for page ${page}.</div>`;
      }
    }

    function renderSections(groups, sesi, semester, page) {
      let html = `<h4 style="color: var(--primary); margin: 20px 0;">Valid Sections â€“ ${sesi} Semester ${semester} (Page ${page} of ${totalPages})</h4>`;

      groups.forEach(group => {
        const allSearchable = group.sections
          .map(s => s.searchable)
          .join(' ')
          .replace(/"/g, '&quot;');

        html += `
          <div class="subject-card" data-search="${allSearchable}">
            <header><h5>${group.kod || 'â€”'} â€“ ${group.nama || 'Unnamed Subject'}</h5></header>
            <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Section</th>
                  <th>Lecturer</th>
                  <th>Enrolled</th>
                  <th>Schedule (Day â€“ Time â€“ Room)</th>
                </tr>
              </thead>
              <tbody>`;

        group.sections.forEach(sec => {
          const scheduleHtml = sec.scheduleEntries.length > 0
            ? sec.scheduleEntries.map(e => `<div class="schedule-entry">${e.day} â€“ ${e.time} â€“ ${e.room}</div>`).join('')
            : '<span style="color:#999;">No schedule</span>';

          html += `
            <tr>
              <td><strong>${sec.seksyen || 'â€”'}</strong></td>
              <td>${sec.lecturer || 'TBA'}</td>
              <td>${sec.enrolled}</td>
              <td>${scheduleHtml}</td>
            </tr>`;
        });

        html += `
              </tbody>
            </table>
            </div>
            <div class="summary">Total Sections: ${group.sections.length}</div>
          </div>`;
      });

      // Pagination
      html += `
        <div class="pagination">
          <button ${page <= 1 ? 'disabled' : ''} onclick="loadPage(${page - 1})">&laquo; Prev</button>
          <span class="page-info">Page ${page} of ${totalPages}</span>
          <button ${page >= totalPages ? 'disabled' : ''} onclick="loadPage(${page + 1})">Next &raquo;</button>
        </div>`;

      html += `<div class="summary">Page ${page}: ${globalEnrichedData.length} section(s) shown</div>`;

      document.getElementById("sectionsContent").innerHTML = html;
    }

    window.loadPage = loadPage; // Expose for pagination buttons

    function filterSections() {
      const input = document.getElementById("searchInput").value.trim();
      const items = document.querySelectorAll(".subject-card");

      if (!input) {
        items.forEach(item => item.style.display = "");
        return;
      }

      const queryWords = input.toLowerCase().split(/\s+/).filter(word => word);
      items.forEach(item => {
        const text = (item.getAttribute("data-search") || "").toLowerCase();
        const matches = queryWords.every(word => text.includes(word));
        item.style.display = matches ? "" : "none";
      });
    }
  })();
</script>
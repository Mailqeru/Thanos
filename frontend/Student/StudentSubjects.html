<div class="subjects-container">
  <h3>My Subjects</h3>

  <div class="filter-group">
    <label for="sessionSelect">Select Session/Semester:</label>
    <select id="sessionSelect" onchange="showSelectedSubjects()">
      <option value="">Loading...</option>
    </select>
  </div>

  <div id="subjectsContent">
    <div class="loading">Loading your subjects...</div>
  </div>
</div>

<style>
  .subjects-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .subjects-container h3 {
    color: var(--primary);
    margin-bottom: 20px;
    font-weight: 600;
    font-size: 24px;
  }

  .filter-group {
    margin-bottom: 24px;
  }

  .filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #444;
  }

  .filter-group select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-color, #d1d5db);
    border-radius: 8px;
    font-size: 16px;
    background-color: white;
    color: #333;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }

  .subject-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    margin-bottom: 24px;
    overflow: hidden;
    border: 1px solid #eaeef5;
  }

  .subject-card header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    padding: 14px 20px;
  }

  .subject-card header h4 {
    margin: 0;
    color: white;
    font-size: 18px;
    font-weight: 600;
  }

  .subject-card table {
    width: 100%;
    border-collapse: collapse;
  }

  .subject-card th,
  .subject-card td {
    padding: 14px 20px;
    text-align: left;
    border-bottom: 1px solid #f0f2f8;
  }

  .subject-card thead th {
    background-color: #f8f9ff;
    color: var(--primary);
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .subject-card tbody tr:hover {
    background-color: #fafbff;
  }

  .subject-summary {
    padding: 14px 20px;
    background-color: #f0f5ff;
    font-weight: 600;
    color: var(--primary);
    font-size: 14px;
  }

  .empty-message {
    text-align: center;
    padding: 30px;
    color: #666;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid #eee;
  }

  .loading {
    color: var(--primary);
    font-style: italic;
    text-align: center;
    padding: 30px;
    font-size: 16px;
  }

  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  @media (max-width: 600px) {
    .subjects-container {
      padding: 0 12px;
    }

    .subjects-container h3 {
      font-size: 20px;
    }

    .subject-card th,
    .subject-card td {
      padding: 10px;
      font-size: 13px;
    }

    .subject-card header h4 {
      font-size: 16px;
    }

    .filter-group select {
      padding: 10px 14px;
      font-size: 14px;
      padding-right: 36px;
    }
  }
</style>

<script>
  (function() {
    console.log("üìö Student Subjects fragment loaded");

    const contentEl = document.getElementById("subjectsContent");
    const selectEl = document.getElementById("sessionSelect");

    const userSession = localStorage.getItem("TTMSFC_userSession");
    if (!userSession) {
      contentEl.innerHTML = `<div class="empty-message">Session expired. Please log in again.</div>`;
      selectEl.innerHTML = "<option>Not logged in</option>";
      return;
    }

    let user, matricNo;
    try {
      user = JSON.parse(userSession);
      matricNo = user.login_name || user.login;
    } catch (e) {
      contentEl.innerHTML = `<div class="empty-message">Invalid session data. Please log in again.</div>`;
      return;
    }

    if (!matricNo) {
      contentEl.innerHTML = `<div class="empty-message">Matric number not found in session.</div>`;
      return;
    }

    const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${encodeURIComponent(matricNo)}`;

    fetch(url)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load subjects');
        return res.json();
      })
      .then(data => {
        if (Array.isArray(data) && data.length > 0) {
          window.studentSubjectsData = data; // Store globally for filter function
          populateSessionDropdown(data);

          const grouped = groupSubjects(data);
          const sortedKeys = Object.keys(grouped).sort().reverse();
          if (sortedKeys.length > 0) {
            selectEl.value = sortedKeys[0];
            showSelectedSubjects();
          }
        } else {
          selectEl.innerHTML = "<option>No sessions available</option>";
          contentEl.innerHTML = `<div class="empty-message">No subjects found.</div>`;
        }
      })
      .catch(err => {
        console.error("‚ùå Error loading subjects:", err);
        selectEl.innerHTML = "<option>Error loading</option>";
        contentEl.innerHTML = `<div class="empty-message">Failed to load subjects: ${err.message || 'Unknown error'}</div>`;
      });
  })();

  function groupSubjects(data) {
    const grouped = {};
    data.forEach(item => {
      const key = (item.sesi || 'Unknown') + ' - Sem ' + (item.semester || 'N/A');
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(item);
    });
    return grouped;
  }

  function populateSessionDropdown(data) {
    const grouped = groupSubjects(data);
    const select = document.getElementById("sessionSelect");
    let options = '<option value="">-- All Sessions --</option>';

    const sortedKeys = Object.keys(grouped).sort().reverse();
    sortedKeys.forEach(key => {
      options += `<option value="${key}">${key}</option>`;
    });

    select.innerHTML = options;
  }

  function showSelectedSubjects() {
    const selectedKey = document.getElementById("sessionSelect").value;
    const data = window.studentSubjectsData || [];
    const grouped = groupSubjects(data);

    if (!selectedKey) {
      let html = '';
      const sortedKeys = Object.keys(grouped).sort().reverse();
      sortedKeys.forEach(key => {
        html += buildSubjectCard(key, grouped[key]);
      });
      document.getElementById("subjectsContent").innerHTML = html || `<div class="empty-message">No subjects to display.</div>`;
    } else if (grouped[selectedKey]) {
      document.getElementById("subjectsContent").innerHTML = buildSubjectCard(selectedKey, grouped[selectedKey]);
    } else {
      document.getElementById("subjectsContent").innerHTML = `<div class="empty-message">No subjects found for this session.</div>`;
    }
  }

  function buildSubjectCard(title, subjects) {
    let html = `<div class="subject-card">`;
    html += `<header><h4>${title}</h4></header>`;
    html += `<div class="table-container">`;
    html += `<table>`;
    html += `<thead><tr>
               <th>Course Code</th>
               <th>Course Name</th>
               <th>Section</th>
             </tr></thead>`;
    html += `<tbody>`;

    subjects.forEach(item => {
      html += `<tr>
                 <td>${item.kod_subjek || '‚Äî'}</td>
                 <td>${item.nama_subjek || '‚Äî'}</td>
                 <td>${item.seksyen || '‚Äî'}</td>
               </tr>`;
    });

    html += `</tbody></table></div>`;
    html += `<div class="subject-summary">Total Subjects: ${subjects.length}</div>`;
    html += `</div>`;
    return html;
  }
</script>
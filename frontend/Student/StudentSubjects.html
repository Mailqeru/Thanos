<!DOCTYPE html>
<html>
<head>
  <title>My Subjects</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .loading { color: #1976D2; font-style: italic; }
  </style>
</head>
<body>

<div class="w3-container">
  <h3>My Subjects</h3>
  
  <!-- Dropdown to select session/semester -->
  <div class="w3-margin-bottom">
    <label for="sessionSelect">Select Session/Semester:</label>
    <select id="sessionSelect" class="w3-select" onchange="showSelectedSubjects()">
      <option value="">Loading...</option>
    </select>
  </div>

  <!-- Container to display subjects for the selected session -->
  <div id="subjectsContent">
    <p>Select a session/semester to view your subjects.</p>
  </div>
</div>

<script>
  // âœ… Safe global variable: use `var` or check existence
  var allSubjects = window.allSubjects || [];

  (function() {
    var userSession = localStorage.getItem("TTMSFC_userSession");
    if (!userSession) {
      document.getElementById("subjectsContent").innerHTML = 
        "<p class='w3-text-red'>Session expired. Please login again.</p>";
      document.getElementById("sessionSelect").innerHTML = 
        "<option>Not logged in</option>";
      return;
    }
    
    try {
      var user = JSON.parse(userSession);
      var matricNo = user.login_name;
    } catch (e) {
      document.getElementById("subjectsContent").innerHTML = 
        "<p class='w3-text-red'>Invalid session data. Please log in again.</p>";
      return;
    }
    
    console.log("Fetching subjects for:", matricNo);
    var url = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=" + encodeURIComponent(matricNo);

    fetch(url)
      .then(res => {
        if (!res.ok) throw new Error('Network response was not ok');
        return res.json();
      })
      .then(data => {
        if (Array.isArray(data) && data.length > 0) {
          allSubjects = data; // update global
          window.allSubjects = allSubjects; // optional: attach to window explicitly
          populateSessionDropdown(data);
          
          // Auto-select latest session
          const grouped = groupSubjects(data);
          const sortedKeys = Object.keys(grouped).sort().reverse();
          if (sortedKeys.length > 0) {
            document.getElementById("sessionSelect").value = sortedKeys[0];
            showSelectedSubjects();
          }
        } else {
          document.getElementById("sessionSelect").innerHTML = 
            "<option>No sessions available</option>";
          document.getElementById("subjectsContent").innerHTML = 
            "<div class='w3-panel w3-pale-yellow w3-border'><p>No subjects found.</p></div>";
        }
      })
      .catch(err => {
        console.error("Error loading subjects:", err);
        document.getElementById("sessionSelect").innerHTML = 
          "<option>Error loading</option>";
        document.getElementById("subjectsContent").innerHTML = 
          `<div class='w3-panel w3-pale-red w3-border'>
            <p>Failed to load subjects: ${err.message || 'Unknown error'}</p>
          </div>`;
      });
  })();

  function groupSubjects(data) {
    const grouped = {};
    data.forEach(item => {
      const key = (item.sesi || 'Unknown') + ' - Sem ' + (item.semester || 'N/A');
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(item);
    });
    return grouped;
  }

  function populateSessionDropdown(data) {
    const grouped = groupSubjects(data);
    const select = document.getElementById("sessionSelect");
    let options = '<option value="">-- All Sessions --</option>';
    
    const sortedKeys = Object.keys(grouped).sort().reverse();

    sortedKeys.forEach(key => {
      options += `<option value="${key}">${key}</option>`;
    });
    
    select.innerHTML = options;
  }

  function showSelectedSubjects() {
    const selectedKey = document.getElementById("sessionSelect").value;
    const grouped = groupSubjects(allSubjects);
    
    if (!selectedKey) {
      let html = '';
      for (let key in grouped) {
        if (grouped.hasOwnProperty(key)) {
          html += buildSubjectTable(key, grouped[key]);
        }
      }
      document.getElementById("subjectsContent").innerHTML = 
        html || "<p>No subjects to display.</p>";
    } else if (grouped[selectedKey]) {
      document.getElementById("subjectsContent").innerHTML = 
        buildSubjectTable(selectedKey, grouped[selectedKey]);
    } else {
      document.getElementById("subjectsContent").innerHTML = 
        "<p>No subjects found for this session.</p>";
    }
  }

  function buildSubjectTable(title, subjects) {
    let html = `<div class="w3-panel w3-card-4" style="margin-bottom:20px;">`;
    html += `<header class="w3-container w3-blue"><h4>${title}</h4></header>`;
    html += `<table class="w3-table-all w3-hoverable">`;
    html += `<thead><tr class="w3-light-blue">
               <th>Course Code</th>
               <th>Course Name</th>
               <th>Section</th>
             </tr></thead><tbody>`;

    subjects.forEach(item => {
      html += `<tr>
                 <td>${item.kod_subjek || 'N/A'}</td>
                 <td>${item.nama_subjek || 'N/A'}</td>
                 <td>${item.seksyen || 'N/A'}</td>
               </tr>`;
    });

    html += `</tbody></table>`;
    html += `<div class="w3-container"><p><b>Total Subjects:</b> ${subjects.length}</p></div>`;
    html += `</div>`;
    return html;
  }
</script>
</body>
</html>